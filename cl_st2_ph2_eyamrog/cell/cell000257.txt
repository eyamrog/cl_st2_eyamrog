Title: A Unified Framework for Dopamine Signals across Timescales


Abstract: Summary

Rapid phasic activity of midbrain dopamine neurons is thought to signal reward prediction errors (RPEs), resembling temporal difference errors used in machine learning. However, recent studies describing slowly increasing dopamine signals have instead proposed that they represent state values and arise independent from somatic spiking activity. Here we developed experimental paradigms using virtual reality that disambiguate RPEs from values. We examined dopamine circuit activity at various stages, including somatic spiking, calcium signals at somata and axons, and striatal dopamine concentrations. Our results demonstrate that ramping dopamine signals are consistent with RPEs rather than value, and this ramping is observed at all stages examined. Ramping dopamine signals can be driven by a dynamic stimulus that indicates a gradual approach to a reward. We provide a unified computational understanding of rapid phasic and slowly ramping dopamine signals: dopamine neurons perform a derivative-like computation over values on a moment-by-moment basis.

Section: Introduction

Dopamine has important roles in controlling learning, motivation, and movement. Understanding what information dopamine conveys is critical for determining how dopamine regulates various functions. One influential idea is that a phasic activity of midbrain dopamine neurons represents temporal difference (TD) reward prediction errors (RPEs) used in reinforcement learning algorithms ( Schultz et al., 1997 57. Schultz, W. ∙ Dayan, P. ∙ Montague, P.R. A neural substrate of prediction and reward Science. 1997; 275 :1593-1599 Crossref Scopus (6380) PubMed Google Scholar ; Niv, 2009 48. Niv, Y. Reinforcement learning in the brain J. Math. Psychol. 2009; 53 :139-154 Crossref Scopus (435) Google Scholar ; Eshel et al., 2015 19. Eshel, N. ∙ Bukwich, M. ∙ Rao, V. ... Arithmetic and local circuitry underlying dopamine prediction errors Nature. 2015; 525 :243-246 Crossref Scopus (217) PubMed Google Scholar ; Starkweather et al., 2017 59. Starkweather, C.K. ∙ Babayan, B.M. ∙ Uchida, N. ... Dopamine reward prediction errors reflect hidden-state inference across time Nat. Neurosci. 2017; 20 :581-589 Crossref Scopus (106) PubMed Google Scholar ). Response patterns that conform TD RPEs have been observed in a number of animal species and under different task conditions ( Bayer and Glimcher, 2005 5. Bayer, H.M. ∙ Glimcher, P.W. Midbrain dopamine neurons encode a quantitative reward prediction error signal Neuron. 2005; 47 :129-141 Full Text Full Text (PDF) Scopus (876) PubMed Google Scholar ; Clark et al., 2012 13. Clark, J.J. ∙ Hollon, N.G. ∙ Phillips, P.E.M. Pavlovian valuation systems in learning and decision making Curr. Opin. Neurobiol. 2012; 22 :1054-1061 Crossref Scopus (82) PubMed Google Scholar ; Watabe-Uchida et al., 2017 69. Watabe-Uchida, M. ∙ Eshel, N. ∙ Uchida, N. Neural Circuitry of Reward Prediction Error Annu. Rev. Neurosci. 2017; 40 :373-394 Crossref Scopus (203) PubMed Google Scholar ), and the RPE hypothesis has greatly affected our understanding of dopamine functions. However, many of these experiments have employed relatively simple behavioral paradigms using discrete stimuli and outcomes. Whether the same principle applies in more complex contexts remains to be examined.
Several studies using animals that can move within an environment have shown that dopamine concentrations in the striatum ramp up over a timescale of seconds ( Phillips et al., 2003 50. Phillips, P.E.M. ∙ Stuber, G.D. ∙ Heien, M.L.A.V. ... Subsecond dopamine release promotes cocaine seeking Nature. 2003; 422 :614-618 Crossref Scopus (886) PubMed Google Scholar ; Roitman et al., 2004 53. Roitman, M.F. ∙ Stuber, G.D. ∙ Phillips, P.E.M. ... Dopamine operates as a subsecond modulator of food seeking J. Neurosci. 2004; 24 :1265-1271 Crossref Scopus (562) PubMed Google Scholar ; Howe et al., 2013 31. Howe, M.W. ∙ Tierney, P.L. ∙ Sandberg, S.G. ... Prolonged dopamine signalling in striatum signals proximity and value of distant rewards Nature. 2013; 500 :575-579 Crossref Scopus (357) PubMed Google Scholar ; Hamid et al., 2016 27. Hamid, A.A. ∙ Pettibone, J.R. ∙ Mabrouk, O.S. ... Mesolimbic dopamine signals the value of work Nat. Neurosci. 2016; 19 :117-126 Crossref Scopus (474) PubMed Google Scholar ; Berke, 2018 7. Berke, J.D. What does dopamine mean? Nat. Neurosci. 2018; 21 :787-793 Crossref Scopus (494) PubMed Google Scholar ; Mohebi et al., 2019 46. Mohebi, A. ∙ Pettibone, J.R. ∙ Hamid, A.A. ... Dissociable dopamine dynamics for learning and motivation Nature. 2019; 570 :65-70 Crossref Scopus (354) PubMed Google Scholar ; Engelhard et al., 2019 18. Engelhard, B. ∙ Finkelstein, J. ∙ Cox, J. ... Specialized coding of sensory, motor and cognitive variables in VTA dopamine neurons Nature. 2019; 570 :509-513 Crossref Scopus (244) PubMed Google Scholar ). Some authors have argued that these slow dopamine fluctuations cannot be readily explained by TD RPEs and have alternatively proposed that they represent the value of the state (state value or motivational value), which increases as the animal approaches a reward location ( Berke, 2018 7. Berke, J.D. What does dopamine mean? Nat. Neurosci. 2018; 21 :787-793 Crossref Scopus (494) PubMed Google Scholar ; Hamid et al., 2016 27. Hamid, A.A. ∙ Pettibone, J.R. ∙ Mabrouk, O.S. ... Mesolimbic dopamine signals the value of work Nat. Neurosci. 2016; 19 :117-126 Crossref Scopus (474) PubMed Google Scholar ; Howe et al., 2013 31. Howe, M.W. ∙ Tierney, P.L. ∙ Sandberg, S.G. ... Prolonged dopamine signalling in striatum signals proximity and value of distant rewards Nature. 2013; 500 :575-579 Crossref Scopus (357) PubMed Google Scholar ). Furthermore, a recent study ( Mohebi et al., 2019 46. Mohebi, A. ∙ Pettibone, J.R. ∙ Hamid, A.A. ... Dissociable dopamine dynamics for learning and motivation Nature. 2019; 570 :65-70 Crossref Scopus (354) PubMed Google Scholar ) concluded that these ramping activities are absent in the spiking activity of dopamine neurons in the ventral tegmental area (VTA) and that ramping dopamine signals arise from local modulation of dopamine axons in the striatum. However, more work is needed to determine (1) what mechanisms underlie generation of ramping dopamine signals and (2) what behavioral conditions cause ramping dopamine signals.
Theoretically, value is separable from RPE. TD RPE ( 𝛿 𝑡 ) is defined by 𝛿 𝑡 = 𝑟 𝑡 + 𝛾 ⁢ ̂ 𝑉 ⁡ ( 𝑆 𝑡 + 1 ) − ̂ 𝑉 ⁡ ( 𝑆 𝑡 ) , where 𝑟 𝑡 is the reward the animal receives at time t , 𝑆 𝑡 is the state the animal occupies at time t , 𝛾 is the discounting factor ( 0 < 𝛾 < 1 ) , and ̂ 𝑉 ⁡ ( 𝑆 𝑡 ) is the value of the state 𝑆 𝑡 (i.e., state value), defined as the sum of all future rewards, where future rewards are discounted exponentially with factor 𝛾 ( STAR Methods ). TD RPE contains terms that are approximately the difference between values at consecutive time points, 𝑡 and 𝑡 + 1 (i.e., 𝛾 ⁢ ̂ 𝑉 ⁡ ( 𝑆 𝑡 + 1 ) − ̂ 𝑉 ⁡ ( 𝑆 𝑡 ) , where 𝛾 is close to 1). Thus, in the absence of an immediate reward, TD RPEs are approximately the derivative of value. The idea that dopamine represents value is therefore incompatible with the view that dopamine represents TD RPEs.
Under many conditions, however, it is difficult to disambiguate RPE and value. A dopamine ramp can occur regardless of whether dopamine represents RPEs or value ( Gershman, 2014 23. Gershman, S.J. Dopamine ramps are a consequence of reward prediction errors Neural Comput. 2014; 26 :467-471 Crossref Scopus (35) PubMed Google Scholar ; Lloyd and Dayan, 2015 40. Lloyd, K. ∙ Dayan, P. Tamping Ramping: Algorithmic, Implementational, and Computational Explanations of Phasic Dopamine Signals in the Accumbens PLoS Comput. Biol. 2015; 11 :e1004622 Crossref Scopus (31) PubMed Google Scholar ; Morita and Kato, 2014 47. Morita, K. ∙ Kato, A. Striatal dopamine ramping may indicate flexible reinforcement learning with forgetting in the cortico-basal ganglia circuits Front. Neural Circuits. 2014; 8 :36 PubMed Google Scholar ). A theoretical study showed that the shape of the value function matters; if the value function is a sufficiently convex function of proximity to reward, then a TD RPE can exhibit a positive ramp ( Gershman, 2014 23. Gershman, S.J. Dopamine ramps are a consequence of reward prediction errors Neural Comput. 2014; 26 :467-471 Crossref Scopus (35) PubMed Google Scholar ) ( STAR Methods ; Figure S1 ). Therefore, the mere presence of a dopamine ramp does not distinguish the two possibilities.
Here we sought to develop experimental paradigms that empirically dissociate RPE from value. We focused on the core property of RPE, that RPE is approximately the derivative of value. Our experiments using visual virtual reality allowed us to tease apart these two possibilities. The results demonstrate that ramping dopamine signals are consistent with TD RPE but inconsistent with value.

Section: Results

Imagine that a mouse moves along a linear track to obtain reward ( Figure 1 A). One can assume that the value of the animal’s location increases monotonically as it approaches the reward. Now imagine that, while moving, the animal is suddenly teleported to a location closer to the goal ( Figure 1 B). If dopamine represents value, then it should exhibit a step-like increase at the time of teleportation and then continue increasing gradually, with the maximum level reached at the goal ( Figure 1 C, left). In contrast, if dopamine represents RPE, then it should exhibit a phasic excitation at the time of teleportation, reflecting an instantaneous increase in value ( Figure 1 C, right). Next, imagine that the speed of the mouse is manipulated ( Figure 1 D). If dopamine represents RPE, then the magnitude of the ramp will be modulated by the speed, with greater magnitudes for faster speeds ( Figure 1 E, right). In contrast, the value will reach the same level just prior to reward irrespective of the speed ( Figure 1 E, left). Importantly, this experiment directly tests the property of ramping itself, whether the ramp is consistent with RPE or value. The primary goal of these experiments is to distinguish whether dopamine signals are consistent with a monotonically increasing function that is dependent on the position or the derivative of that function. The former would support the value hypothesis, whereas the latter would support the RPE hypothesis.
We used virtual reality in head-fixed mice ( Dombeck et al., 2007 17. Dombeck, D.A. ∙ Khabbaz, A.N. ∙ Collman, F. ... Imaging large-scale neural activity with cellular resolution in awake, mobile mice Neuron. 2007; 56 :43-57 Full Text Full Text (PDF) Scopus (809) PubMed Google Scholar ) to perform teleportation and speed manipulations. In the first set of experiments, the visual scene ( Figure 1 F) moved at a constant speed and the mice received a drop of water (5 μL) at the goal location ( Video S1 ). Over several days, mice developed anticipatory licking near the goal ( Figure 1 G, top; n = 16 mice, p = 0.00043, Wilcoxon signed-rank test). Although the scene moved constantly irrespective of locomotor movement (i.e., “passive” condition), more than half of the animals developed running behavior ( Figure 1 G, bottom).
Video (5.48 MB) Video S1. Visual Stimulus under the Standard Approach to Target Condition, Related to Figure 1
We first monitored calcium signals from dopaminergic axons projecting to the ventral striatum (VS, or nucleus accumbens core) ( Babayan et al., 2018 3. Babayan, B.M. ∙ Uchida, N. ∙ Gershman, S.J. Belief state representation in the dopamine system Nat. Commun. 2018; 9 :1891 Crossref Scopus (53) PubMed Google Scholar ; Menegas et al., 2017 43. Menegas, W. ∙ Babayan, B.M. ∙ Uchida, N. ... Opposite initialization to novel cues in dopamine signaling in ventral and posterior striatum in mice eLife. 2017; 6 :e21886 Crossref Scopus (144) PubMed Google Scholar , 2018 44. Menegas, W. ∙ Akiti, K. ∙ Amo, R. ... Dopamine neurons projecting to the posterior striatum reinforce avoidance of threatening stimuli Nat. Neurosci. 2018; 21 :1421-1430 Crossref Scopus (189) PubMed Google Scholar ) using fiber fluorometry (photometry) ( Figures 1 I and 1J). After training, axonal calcium signals ramped up progressively over a timescale of 3–4 s ( Figures 1 K and 1L; Figures S2 E–S2H). We quantified the ramping based on correlation coefficients (r, “ramping R ”) between calcium signals and time (n = 16 mice, r = 0.18 ± 0.04; Pearson correlation using the average calcium trace was 0.45, 95% confidence interval [CI] = [0.43, 0.48], p < 10 −20 ). Across sessions, neither anticipatory licking nor running speed was correlated with the ramping signal (p = 0.37 and 0.13 for anticipatory licking and running speed, respectively; analysis of covariance [ANCOVA], n = 93 sessions from 16 mice). We did not observe a significant difference in ramping 𝑅 s between slow- and fast-running animals ( Figure S2 J).
These ramping dopamine signals are unlikely to be a correlate of licking or motion artifacts. First, mice expressing a calcium-insensitive green fluorescent protein (GFP) did not exhibit ramping ( Figures 1 M and 1N). Second, we have not observed ramping signals using similar techniques in different tasks ( Babayan et al., 2018 3. Babayan, B.M. ∙ Uchida, N. ∙ Gershman, S.J. Belief state representation in the dopamine system Nat. Commun. 2018; 9 :1891 Crossref Scopus (53) PubMed Google Scholar ; Menegas et al., 2017 43. Menegas, W. ∙ Babayan, B.M. ∙ Uchida, N. ... Opposite initialization to novel cues in dopamine signaling in ventral and posterior striatum in mice eLife. 2017; 6 :e21886 Crossref Scopus (144) PubMed Google Scholar , 2018 44. Menegas, W. ∙ Akiti, K. ∙ Amo, R. ... Dopamine neurons projecting to the posterior striatum reinforce avoidance of threatening stimuli Nat. Neurosci. 2018; 21 :1421-1430 Crossref Scopus (189) PubMed Google Scholar ), although anticipatory licking was similar (also see delayed-reward task below). In addition to ramping, we observed a phasic response at the onset of scene movement and a slight decrease just before reward ( STAR Methods ).
We then performed a set of 4 experiments to determine whether dopamine signals represent RPE or value. In experiment 1, in addition to the standard condition, we randomly interleaved three test conditions, which included a long teleportation, a short teleportation, or a 5-s pause ( Figure 2 A; Video S2 ). If dopamine represents value, then dopamine signals would show a step-like increase, arriving at the same level after a long and short teleportation, and should always reach the maximum level just before reward ( Figure 2 B, left). If dopamine represents RPE, then dopamine signals would show a phasic excitation whose magnitude scales with the length of teleportation ( Figure 2 B, right). Value depending on the distance to reward will stay constant when scene movement is paused, whereas RPE will decrease to baseline because there is no change of value in time. There is some ambiguity regarding how “value” may behave under the pause condition; for example, if the animal judges that the task is aborted at the time of pause, then the value may also decrease to baseline. We used the results holistically to judge which hypothesis parsimoniously accounts for the entire data.
Video (5.38 MB) Video S2. Visual Stimuli in Experiment 1 (the Long-Distance Teleportation, Short-Distance Teleportation, and Pause Conditions), Related to Figure 2
In teleportation trials, anticipatory licking and changes in locomotor speed reflected the destinations of teleportation ( Figure S3 B), confirming that mice used visual cues to predict reward rather than merely relying on elapsed time. A long teleportation evoked a large calcium transient whose peak was greater than the peak of the ramp under the standard condition ( Figures 2 C and 2D, left; ratio between the peaks, 2.25 ± 0.31; p = 0.0010, n = 11 mice; Figure S3 A). The phasic excitation evoked by a short teleportation was smaller than that evoked by a long teleportation but was still greater than the peak of the ramp under the standard condition, violating the value hypothesis ( Figures 2 C and 2D, left; ratio, 1.35 ± 0.14; p = 0.024, n = 11 mice). In pause trials, the calcium signal decreased to the baseline level, followed by a phasic excitation when scene movement resumed ( Figures 2 C and 2D, left), consistent with RPEs.
To quantify these results, we generated predicted responses based on the value hypothesis ( Figures S4 A–S4D; STAR Methods ). If dopamine represents value, then deviation from these predictions should be small and unsystematic. In most of the animals (9 of 11), the deviations of the observed signals followed a systematic pattern, supporting the RPE hypothesis ( Figure 2 D, right; median test R , r = – 0.64, n = 11 mice, p = 0.002; see STAR Methods for the definition of test R ).
Because value is unobservable, it is generally difficult to assess the shape of value function. In experiment 2, we sought to infer the shape of value function ( Figures 2 E–2H; Figures S3 C and S3D). In test trials, mice were teleported forward from one of three locations by the same distance ( Figure 2 E). If the underlying value function has a convex shape, then the magnitude of response should be larger, with teleportation occurring at locations closer to the goal. Indeed, the phasic calcium signals followed this pattern ( Figure 2 H), consistent with a convex value function.
To test whether the ramping itself represents RPEs, we moved the scene either fast (×2 speed) or slow (×0.5 speed) in test trials (experiment 3; Figures 2 I–2L; Figures S3 E and S3F; Video S3 ). Observed calcium signals were consistent with the RPE predictions ( Figures 2 K and 2L, left; p = 6.1 × 10 −5 and 6.1 × 10 −4 , n = 15 mice). A regression analysis indicated that the magnitude of ramping can be predicted by the speed of the scene but not by locomotion speed ( Figure 2 L, right). GFP control mice did not show systematic modulation ( Figure S4 F).
Video (3.85 MB) Video S3. Visual Stimuli in Experiment 3 (the Slow and Fast Speed Conditions), Related to Figure 2
We note, however, that there was a sudden increase in the signal soon after onset of fast scene movement. This may be because the speed of scene movement became a cue predictive of an early reward. Although this is still consistent with RPE, we designed an additional experiment that minimized this potential confound (experiment 4; Figures 2 M–2P; Figures S3 G–S3I). The speed of scene movement was modulated dynamically over time ( Figure S3 I). This allowed us to change the speed without altering the time to reward between conditions. We found that dopamine responses before reward changed according to the instantaneous speed ( Figure 2 O). The calcium signals immediately preceding the goal diverged greatly ( Figure 2 P; p = 0.002, df = 2, n = 5 mice, F = 14.3, one-way repeated-measures ANOVA), violating the value account, which predicts that dopamine signals should reach the same level at the goal regardless of the speed.
We next used a model fit analysis to test whether the data can be explained better by RPE or value. The state value was first defined as a function of space ( Figure 3 A). Based on this value function, we predicted calcium signals under each condition. We then obtained a set of parameters that minimized the residual sum of squares ( Figures 3 A and 3B). The goodness of fit was quantified using the Akaike information criterion (AIC) to penalize the number of parameters in a model. We first used a value function whose value is discounted by a fixed rate ( 𝜏 ) as a function of the distance to the target (exponential value function; the requirement of a particular shape for the value function will be relaxed later). The RPE model explained the data far better than the value model under all experimental conditions ( Figure 3 D; p < 0.004 for all four fits with manipulated experiments; H 0 , individual median ΔAIC is zero; n = 11, 15, 15, 15 for experiments 1, 2, 3, and all). In contrast, the difference was not significant under the standard condition ( Figure 3 D, standard; p = 0.07, n = 16 mice), indicating that our analysis is unbiased.
We further fitted the data with value functions of more arbitrary shapes (e.g., fifth-order polynomial) ( Figure 3 E, 𝛽 ⁢ 𝑋 ; Figure S4 H), allowing us to derive a value function in a more data-driven manner. We also included a value model in which the state value was computed based on time to reward given the current speed (Δt to reward). The RPE model with a polynomial value function best explained the data. However, even the simple exponential RPE model outperformed all of the value models ( Figure 3 E; p < 0.0003; H 0 , individual median ΔAIC is zero; n = 15 mice). These results indicate that the calcium signals in experiments 1–3 are better explained by RPE than by state value. Note that the fitted models also captured the initial transient response and the dip right before reward (see STAR Methods for a note regarding the shape of the fitted value function).
These analyses demonstrate that RPE models are better than value models when tested one against another. However, it is possible that the responses lie somewhere between these two possibilities. To address this, we first considered a linear combination of RPE and value, with the weight 𝛼 ( 0 ≤ 𝛼 ≤ 1 ) representing the fraction of RPE signals (a mixture model). The fit using this mixture model only barely improved compared with the RPE model ( Figure 3 E, right; the mean R 2 increased by 2%). The weight for the RPE term ( 𝛼 ) was close to 1 ( Figure 3 G; experiments 1–3, 0.92 ± 0.12; experiment 4, 0.99 ± 1.2 × 10 −4 , mean ± SD). Second, we considered the possibility that the responses are between value and RPE in terms of the order of the derivative. Specifically, the RPE approximates the first-order derivative of the value function ( 𝑑 ⁢ 𝑉 / 𝑑 ⁢ 𝑡 ) , whereas the value function itself is its own zeroth-order derivative. The method of “fractional derivatives” allows one to define a non-integer order of derivative ( 𝑑 𝑎 / 𝑑 ⁢ 𝑡 𝑎 ⁢ 𝑉 ) ( Podlubny, 1998 51. Podlubny, I. Fractional differential equations: an introduction to fractional derivatives, fractional differential equations, to methods of their solution and some of their applications Academic Press, 1998 Google Scholar ) by which one can obtain a gradual transition between value and RPE by varying 𝑎 from 0 to 1 ( Figure 3 H, left). We found that the best-fit order of derivative obtained from the data using an exponential value function was close to 1 ( Figure 3 H, right; experiments 1–3, 1.1 ± 0.12; experiment 4, 1.28 ± 0.08, mean ± SD).
These results demonstrate that the RPE model, which computes the first-order derivative of the value function, is a superior model to explain the dopaminergic axonal activity in the VS, with little contribution of value.
Some recent studies have suggested that dopamine neurons are activated by sensory surprise, sensory (identity) prediction error, or arousal ( Schultz, 2019 56. Schultz, W. Recent advances in understanding the role of phasic dopamine activity F1000Res. 2019; 8 :1680 Crossref Scopus (42) Google Scholar ; Stalnaker et al., 2019 58. Stalnaker, T.A. ∙ Howard, J.D. ∙ Takahashi, Y.K. ... Dopamine neuron ensembles signal the content of sensory prediction errors eLife. 2019; 8 :e49315 Crossref Scopus (27) PubMed Google Scholar ; Takahashi et al., 2017 64. Takahashi, Y.K. ∙ Batchelor, H.M. ∙ Liu, B. ... Dopamine Neurons Respond to Errors in the Prediction of Sensory Features of Expected Rewards Neuron. 2017; 95 :1395-1405.e3 Full Text Full Text (PDF) Scopus (116) PubMed Google Scholar ). We next tested whether the above responses were due to sensory surprise using teleportation between two tracks ( Figure 4 A). In test trials, mice were teleported between the tracks without changing the distance to the goal so that a teleportation event caused a sensory prediction error without causing a change in value ( Figures 4 B–4D; Video S4 ). We did not observe a transient excitation at the time of between-track teleportation ( Figure 4 D; Figure S4 I; p = 0.31 and 0.84, n = 6 mice), although forward teleportation caused a large transient activation ( Figures 4 E–4G; Figure S4 J). The lack of response during between-track teleportation is not due to failure to distinguish the two tracks or failure to recognize teleportation. When different amounts of reward were assigned to the two tracks ( Figures 4 H–4J; Figure S4 K), we observed different levels of anticipatory licking and the calcium signal between the two tracks ( Figure 4 J, left and center; p = 0.019 and 0.001 for licking and calcium signal, respectively; n = 4 mice, paired t test). Furthermore, between-track teleportation caused a transient change in the calcium signal consistent with the change in the state values ( Figure 4 J, p = 0.012, n = 4 mice, paired t test). Finally, we also performed backward teleportation with the same magnitude as forward teleportation. Although the amount of sensory surprise was plausibly similar between these conditions, backward teleportation caused a decrease rather than an increase in the calcium signal ( Figures 4 K–4M; Figure S4 L). These results indicate that a pure sensory surprise does not excite dopamine neurons but that a change in value is important.
Video (6.99 MB) Video S4. Visual Stimuli in Experiment 5a (the Standard Condition in Track 2, Teleportation from Track 1 to Track 2, and Teleportation from Track 2 to Track 1), Related to Figure 4
We next examined whether the magnitudes of ramping and teleportation responses are sensitive to reward magnitudes. The amount of reward in track 1 was altered across blocks of trials ( Figures 4 N–4P). In large-reward blocks, mice showed greater anticipatory licking compared with small-reward blocks (p = 0.008, n = 10 mice). The magnitudes of ramping as well as phasic response were greater in large-reward blocks ( Figures 4 O, left, and 4P, left; p = 0.049, n = 10 mice; Figures 4 O, right, and 4P, right; p = 0.0020, n = 10 mice, respectively). Thus, ramping and transient responses to teleportation are sensitive to outcome values.
The responses observed in our experiments cannot be explained by sensory surprise but can be explained parsimoniously by TD RPE—tracking changes of value.
The above results indicate that the activity of dopamine axons in the VS is consistent with TD RPEs. However, it remained unclear whether these results held at the single-neuron level. For instance, different populations of dopamine neurons may separately underlie ramping, transient responses, and speed-dependent modulations. Furthermore, a recent study concluded that the spiking activity of VTA dopamine neurons does not ramp up, suggesting local modulation of dopamine axons independent of somatic spiking activity ( Mohebi et al., 2019 46. Mohebi, A. ∙ Pettibone, J.R. ∙ Hamid, A.A. ... Dissociable dopamine dynamics for learning and motivation Nature. 2019; 570 :65-70 Crossref Scopus (354) PubMed Google Scholar ). To address these issues, we next characterized the spiking activity of VTA dopamine neurons (we focused on experiments 1 and 3, which contain the main experiments shown in Figure 1 ) ( Figure 5 A). The light-gated cation channel (channelrhodopsin-2) was expressed in dopamine neurons, and the recorded neurons were classified as dopaminergic based on the short-latency responses to laser pulses ( Figures S5 A–S5D; Cohen et al., 2012 14. Cohen, J.Y. ∙ Haesler, S. ∙ Vong, L. ... Neuron-type-specific signals for reward and punishment in the ventral tegmental area Nature. 2012; 482 :85-88 Crossref Scopus (899) PubMed Google Scholar ; Lima et al., 2009 39. Lima, S.Q. ∙ Hromádka, T. ∙ Znamenskiy, P. ... PINP: a new method of tagging neuronal populations for identification during in vivo electrophysiological recording PLoS ONE. 2009; 4 :e6099 Crossref Scopus (271) PubMed Google Scholar ). Because VS-projecting dopamine neurons spread along the mediolateral (ML) axis in the VTA ( Farassat et al., 2019 20. Farassat, N. ∙ Costa, K.M. ∙ Stojanovic, S. ... In vivo functional diversity of midbrain dopamine neurons within identified axonal projections eLife. 2019; 8 :e48408 Crossref Scopus (44) PubMed Google Scholar ), we recorded from a wide range along the ML axis (in total, 122 neurons from 13 mice; 102 neurons in the VTA [ML < 900 𝜇 m]).
Most of the optogenetically identified dopamine neurons showed a strong phasic response to reward ( Figure 5 B; 92 of 102 neurons show significance). On average, spiking activity exhibited a positive ramp (slope, 0.16 ± 0.04 spikes/s 2 ). Across neurons, we observed a significant diversity in ramping, with some neurons gradually ramping up and some others ramping down ( Figure 5 C; Figure S5 E). In more medial recordings, more neurons showed a positive ramp, and the magnitude of ramps was greater ( Figures 5 D and 5E, black; slope, 0.41 ± 0.11 spikes/s 2 ). In more lateral recordings, fewer neurons showed a positive ramp, and the magnitude of ramps was smaller ( Figures 5 D and 5E, dark gray; slope, 0.12 ± 0.04 spikes/s 2 ) and diminished, on average, at the most lateral location ( Figures 5 D and 5E, gray; slope, 0.09 ± 0.09 spike/s 2 ). There was a significant correlation between the ramping slope and the ML position ( Figure 5 D; r = –0.21, p = 0.019, n = 122 neurons, Spearman correlation), consistent with single-neuron imaging results ( Engelhard et al., 2019 18. Engelhard, B. ∙ Finkelstein, J. ∙ Cox, J. ... Specialized coding of sensory, motor and cognitive variables in VTA dopamine neurons Nature. 2019; 570 :509-513 Crossref Scopus (244) PubMed Google Scholar ).
We next asked whether the small increase in spiking can account for the ramping in calcium signals ( Figures 1 and 2 ). Predicted calcium signals were computed based on the spiking activity and the impulse response of GCaMP6m ( Figure S5 P; STAR Methods ). We found that ramping signals became more prominent and the phasic responses less prominent compared with the raw firing rates, resulting in a prominent positive ramp in the predicted calcium response from medial neurons and a slightly negative ramp from lateral neurons ( Figure 5 F).
It remains unclear whether the recorded neurons projected to the VS, where we monitored axonal calcium signals ( Figure 2 ). To remedy this issue, we next performed fluorometry from the somata of VTA dopamine neurons that were labeled retrogradely from our recording site in the VS using a modified rabies virus. Inspection of the injection site and the location of somata of labeled neurons indicated that dopamine neurons that projected to our fluorometry recording sites were widely distributed in the VTA but enriched in the medial VTA ( Figures S5 H and S5I; Lammel et al., 2008 38. Lammel, S. ∙ Hetzel, A. ∙ Häckel, O. ... Unique properties of mesoprefrontal neurons within a dual mesocorticolimbic dopamine system Neuron. 2008; 57 :760-773 Full Text Full Text (PDF) Scopus (707) PubMed Google Scholar ; but see Ikemoto, 2007 32. Ikemoto, S. Dopamine reward circuitry: two projection systems from the ventral midbrain to the nucleus accumbens-olfactory tubercle complex Brain Res. Brain Res. Rev. 2007; 56 :27-78 Crossref Scopus (1120) PubMed Google Scholar ). Calcium signals recorded in these retrogradely labeled neurons exhibited a positive ramp ( Figure S5 J).
We next examined whether single-neuron activities were consistent with RPE or value using experiments 1 and 3. As discussed above, the RPE hypothesis would be supported by a phasic response at teleportation and changes in the magnitude of ramping in speed manipulations ( Figures 1 A–1E). In contrast, the presence of positive and negative ramps does not distinguish the two hypotheses; a sufficiently convex value function will cause a positive ramp, as discussed above, but a less convex value function can result in a negative ramp, based on the RPE hypothesis ( Figure S1 ). We found that a large fraction of neurons, including those with a positive, negative, or no ramp ( Figures 5 G–5I), exhibited a phasic response at the time of teleportation (68 of 88 neurons). A phasic response was observed irrespective of whether they had a positive or negative ramp (r = 0.13, p = 0.24; n = 88 neurons, Spearman correlation between response to the long teleportation and ramping R ). The magnitude of the ramp was modulated by the speed of scene movement (median test R, r = 0.18, p = 5.2 × 10 −12 , n = 88 neurons; 27 of 88 neurons significantly greater than zero, Spearman correlation using trial data). The average spiking activity also showed features that are consistent with RPEs, and the predicted calcium responses resembled the axonal calcium signals in the VS ( Figures 5 K and 5L). We also observed a very small number of neurons that did not conform to RPEs ( Figure 5 J).
We next performed a model fit analysis on individual neurons. We applied the same fitting procedure ( Figure 3 A) after smoothing the spiking activity with a relatively narrow filter ( Figures S5 P, S5Q, and S5R). On average, an RPE model with a simple exponential value function outperformed all of the value models we tested ( Figure 5 M, left; p < 2 × 10 −10 for all value models; H 0 , individual median ΔAIC is zero; n = 78). A mixture model that combined RPE and value barely improved the fit compared with the RPE model ( Figure 5 M, right; mean R 2 increase by 1.8%; AIC difference is significant in 1 of 78 neurons), and the weight for RPE was close to 1 ( Figure 5 N; 𝛼 = 0.91 ± 0.20, mean ± SD). The best-fit orders of fractional derivative for individual neurons were close to 1 ( Figure 5 O; a = 1.11 ± 0.27, n = 78 neurons, mean ± SD). Thus, just as with axonal calcium signals, spiking activity encoded RPE nearly exclusively, with little contribution of value.
For a closer inspection, we sorted neurons based on how well the activity was fit by an RPE model over a value model (ΔAIC) ( Figures 5 P and 5Q). The phasic responses to teleportation, the dip at a pause, as well as the responses to different speeds were widespread across neurons ( Figure 5 P). A model fit analysis showed that most neurons preferred RPE over value models ( Figure 5 Q; significant for at least 62 of 78 neurons, three columns of ΔAICs, permutation test). This was true regardless of whether individual neurons ramped up or down ( Figure 5 Q; slope column, r = 0.09, p = 0.42, n = 78 neurons, Spearman correlation). We next inferred the shape of value functions through a model fit analysis using a flexible value function. The average value function derived from the spiking data, although performed completely independent of the measurement of axonal calcium signals, exhibited a remarkable resemblance to the value function derived from the axonal calcium signals ( Figure 5 R; compare with Figure 3 F).
These results indicate that most of single neurons were consistent with RPE and relatively spread across the VTA. Among these neurons, those located in the medial region exhibited more positive ramps.
One potential caveat with the rabies virus ( Figure S5 J) is its toxicity. We therefore used an adeno-associated virus to express GCaMP in VTA dopamine neurons and recorded somatic calcium signals. We found that the calcium signals measured in the VTA showed a similar level of ramping. Further testing in experiments 1–3 ( Figures 6 A–6D; Figure S6 ) showed a striking similarity to the predicted calcium dynamics from the population of VTA dopamine neurons ( Figures 5 K and 5L bottom).
The dynamics of dopamine concentration can be affected by additional factors after release, such as diffusion, receptor binding, and reuptake. If the RPE signal is temporally integrated, then the dopamine concentration could be converted to a value-like quantity. Therefore, we measured dopamine concentration in the VS using a genetically encoded dopamine sensor (GRAB DA2m ) ( Figure 6 E). We found that the dopamine signals were similar to the calcium signals in other experiments ( Figures 6 F–6H). Transient excitation to long teleportation exceeded the peak of ramping under the standard condition ( Figure 6 F; p = 0.004, n = 9 mice), and the magnitude of ramping signals was modulated by the speed of scene movement ( Figure 6 H; median test R, r = 0.43, p = 0.002, n = 10 mice; 9 of 10 mice showed significant test R ). These results suggest that the concentration of dopamine still represents RPE.
In previous experiments, ramping activity was not observed in delayed-reward tasks in which a reward was delivered with a relatively short fixed delay after a cue (e.g., Cohen et al., 2012 14. Cohen, J.Y. ∙ Haesler, S. ∙ Vong, L. ... Neuron-type-specific signals for reward and punishment in the ventral tegmental area Nature. 2012; 482 :85-88 Crossref Scopus (899) PubMed Google Scholar ; Starkweather et al., 2017 59. Starkweather, C.K. ∙ Babayan, B.M. ∙ Uchida, N. ... Dopamine reward prediction errors reflect hidden-state inference across time Nat. Neurosci. 2017; 20 :581-589 Crossref Scopus (106) PubMed Google Scholar ). For more direct comparisons, we used a delayed-reward task using odor cues with delays that covered the timescale of the above tasks ( Figure 7 A; STAR Methods ). A subset of the animals used in single-neuron recordings ( Figure 5 ) also performed in the delayed-reward task in the same session while spikes were recorded continuously. Although anticipatory licking was similar ( Figures S7 A and S7B), the average spiking activity showed a slight negative ramp in the odor task and a positive ramp in the linear track task ( Figures 7 B–7D), demonstrating a task-specific modulation of dopamine neuron activity.
Some animals displayed locomotor activity during the linear track tasks ( Figure 1 G, bottom). However, locomotor activity and the magnitude of ramping were not correlated ( Figure S2 J; Figure 2 L, right). Previous studies ( Hamid et al., 2019 28. Hamid, A.A. ∙ Frank, M.J. ∙ Moore, C.I. Dopamine waves as a mechanism for spatiotemporal credit assignment bioRxiv. 2019; Crossref Scopus (0) Google Scholar ; Mohebi et al., 2019 46. Mohebi, A. ∙ Pettibone, J.R. ∙ Hamid, A.A. ... Dissociable dopamine dynamics for learning and motivation Nature. 2019; 570 :65-70 Crossref Scopus (354) PubMed Google Scholar ) have suggested that dopamine ramps are present in an operant task (when the animal has to take a specific action to obtain a reward) but not in a Pavlovian task (in which a reward is delivered regardless of the animal’s action). Technically, our linear track task is Pavlovian in design. However, it remains unclear how mice understand the task. We therefore designed additional experiments to clarify the task conditions that generate a dopamine ramp.
We trained a new set of mice in an operant contingency so that mice had to locomote a certain distance to obtain a reward. We observed a dopamine ramp similar to the Pavlovian design used above ( Figure S7 C). The results with teleportation ( Figures S7 D and S7H) and speed manipulations ( Figures S7 E and S7I) were also similar, indicating that the ramping activity in the operant context also represented RPEs. To assess the role of cues, we introduced other tracks in which animals could not estimate their position based on the visual input. The modified tracks had a uniform wall pattern ( Figure 7 E) or no pattern ( Figure 7 F). Although the animals showed anticipatory licking ( Figure S7 J), the timing of licking became broader ( Figures S7 F and S7G, top). Under these two manipulation conditions, we did not observe a positive ramp, although scene movement onset caused a small increase in calcium that somewhat persisted before reward ( Figures 7 F and 7G, bottom). Thus, whether the animal has to perform a certain movement to obtain a reward is not important for generating a dopamine ramp. Instead, the results highlight the importance of cues for the proximity to the reward.
To test whether a dopamine ramp could be generated by a non-navigational cue, we used a black horizontal bar that moved downward from the top of computer monitors. The animal received a drop of water when the bar reached a certain location ( Figure 7 H; Video S5 ). Consistent with our hypothesis, when the animal learned the task ( Figure S7 K), we observed a dopamine ramp similar to that in the linear track task ( Figure S7 L).
Video (3.36 MB) Video S5. Moving-Bar Stimulus under the Standard Condition, Related to Figure 7
We next performed a series of experiments analogous to experiments 1–3 using moving bars. The results were largely consistent with those obtained using navigational stimuli ( Figures 7 I–7K; Figures S7 M–S7O). Model fit analysis confirmed that the RPE model explained the data better than the value model ( Figures 7 L–7N). Furthermore, dopamine signals in the VS, measured using GRAB DA2m , showed similar results ( Figures 7 O–7Q). These results demonstrate that dynamic cues that indicate proximity to reward can cause ramping dopamine neuron activity and that the ramping activity encodes the TD RPE.

Section: Discussion

In this study, we developed a set of experimental paradigms to dissociate RPE and value, which are otherwise difficult to disambiguate. We found that teleportation and speed manipulations caused a phasic dopamine response and a change in the magnitudes of ramps, respectively, that were consistent with RPE. Furthermore, this was true at all of the stages of dopamine transmission we examined: spiking activity and calcium signals at somata, calcium signals at axons, and dopamine concentrations in the VS. We also showed that cues that indicate a gradual increase in temporal proximity to reward play an essential role in causing a dopamine ramp, regardless of whether the cue is navigational or more abstract or the task is operant or Pavlovian. We demonstrated that slowly fluctuating dopamine signals at a second timescale encode RPEs, similar to phasic dopamine signals. Our results thus provide a unified account of dopamine signals across these timescales as RPEs. Computing moment-by-moment changes in values is a hallmark of TD RPEs, which provides a solution to credit assignment problems in machine learning ( Sutton and Barto, 1998 63. Sutton, R.S. ∙ Barto, A.G. Reinforcement Learning: An introduction MIT Press, 1998 Google Scholar ). However, whether dopamine neurons in the brain compute RPE in this manner has not been tested. Our results demonstrate that dopamine neurons compute a derivative-like signal over value on a moment-by-moment basis, instantiating the central tenet of TD error signals.
The present study was originally motivated by the prediction that TD error can ramp up when the value function is sufficiently convex ( Gershman, 2014 23. Gershman, S.J. Dopamine ramps are a consequence of reward prediction errors Neural Comput. 2014; 26 :467-471 Crossref Scopus (35) PubMed Google Scholar ). However, our interpretation is not bound to this hypothesis. Rather, the question is whether dopamine signals can be explained by a monotonically increasing function defined over space or by its derivative. More generally, we sought to empirically derive a parsimonious mathematical description of dopamine signals based on a set of parameters in the experiment. Our model-fitting results demonstrate that, by assuming the presence of a function that increases with proximity to reward, the dopamine signals can be described by its first derivative. Other observations, such as the dependency on reward amounts and the lack of response to sensory surprises, indicate that these functions match well with what we conceive as value and TD error. It is through these analyses that we inferred the potential value function under the “minimum” assumptions (the presence of a monotonically increasing function and allowing the dopaminergic activity to represent the [fractional] derivative of it). However, these analyses are not completely “assumption free.” It will be interesting to address whether we can derive a set of mathematical equations for dopamine signals in a more data-driven manner from a more diverse set of potential functions ( Schmidt and Lipson, 2009 54. Schmidt, M. ∙ Lipson, H. Distilling free-form natural laws from experimental data Science. 2009; 324 :81-85 Crossref Scopus (1785) PubMed Google Scholar ; Brunton et al., 2016 9. Brunton, S.L. ∙ Proctor, J.L. ∙ Kutz, J.N. Discovering governing equations from data by sparse identification of nonlinear dynamical systems Proc. Natl. Acad. Sci. USA. 2016; 113 :3932-3937 Crossref Scopus (2281) PubMed Google Scholar ).
It remains to be determined to what extent our results can be generalized. A recent study suggested that dopamine ramps can occur even without an explicit sensory cue when the reward is given after running a certain distance in a running wheel ( Guru et al., 2020 26. Guru, A. ∙ Seo, C. ∙ Post, R.J. ... Ramping activity in midbrain dopamine neurons signifies the use of a cognitive map bioRxiv. 2020; Crossref Scopus (0) Google Scholar ). It may be difficult to eliminate all sensory cues in such an experiment (e.g., the rotation of the wheel may provide a cue). Furthermore, it is possible that an animal’s own movement acts as a cue ( Killeen and Fetterman, 1988 33. Killeen, P.R. ∙ Fetterman, J.G. A behavioral theory of timing Psychol. Rev. 1988; 95 :274-295 Crossref Scopus (574) PubMed Google Scholar ). In our experiment, a dopamine ramp was not observed without a positional cue even when the reward was given after running a fixed distance ( Figures 7 E–7G). However, we cannot exclude the possibility that, after sufficient training, a dopamine ramp may occur. Furthermore, it has been suggested that dopamine ramps become smaller after extensive training under some conditions ( Guru et al., 2020 26. Guru, A. ∙ Seo, C. ∙ Post, R.J. ... Ramping activity in midbrain dopamine neurons signifies the use of a cognitive map bioRxiv. 2020; Crossref Scopus (0) Google Scholar ). Our experiments typically contained test trials that might have prevented the animals from completely learning the standard condition. Furthermore, virtual reality does not completely reproduce a real environment. For instance, the spatial cues in our experiment may be less intuitive compared with those in a real environment, which might have reduced the effectiveness of learning. Finally, our results are consistent with a value function that is tied to position. This is likely because position, more so than other parameters in our experiment, served as a reasonable predictor of proximity to reward. If a different variable were a better predictor of proximity to reward, it is possible that the value function may, in that case, be a function of that variable rather than position, as suggested from our moving-bar experiment.
Although our results show that ramping dopamine signals are present in spiking activity of dopamine neurons, we cannot exclude the possibility that axonal modulation also has a role in shaping the signal. Dopamine release can be modulated locally at axons of dopamine neurons ( Cachope et al., 2012 10. Cachope, R. ∙ Mateo, Y. ∙ Mathur, B.N. ... Selective activation of cholinergic interneurons enhances accumbal phasic dopamine release: setting the tone for reward processing Cell Rep. 2012; 2 :33-41 Full Text Full Text (PDF) Scopus (364) PubMed Google Scholar ; Threlfell et al., 2012 65. Threlfell, S. ∙ Lalic, T. ∙ Platt, N.J. ... Striatal dopamine release is triggered by synchronized activity in cholinergic interneurons Neuron. 2012; 75 :58-64 Full Text Full Text (PDF) Scopus (590) PubMed Google Scholar ; Zhou et al., 2001 70. Zhou, F.M. ∙ Liang, Y. ∙ Dani, J.A. Endogenous nicotinic cholinergic activity regulates dopamine release in the striatum Nat. Neurosci. 2001; 4 :1224-1229 Crossref Scopus (463) PubMed Google Scholar ). It is generally difficult to make a direct comparison between somatic activity and neurotransmitter release in vivo because drawing a conclusion requires a complete match between the cell bodies and the axons that are observed and because there may be some nonlinear relationship between spiking activity and transmitter release.
However, ramping signals were present at the somata at the level of action potentials and associated calcium signals. This was also the case in dopamine neurons labeled retrogradely from the VS, where the axonal activity was monitored. Interestingly, we observed an ML gradient of ramping signals in the VTA ( Figure 5 D). The fact that one study ( Mohebi et al., 2019 46. Mohebi, A. ∙ Pettibone, J.R. ∙ Hamid, A.A. ... Dissociable dopamine dynamics for learning and motivation Nature. 2019; 570 :65-70 Crossref Scopus (354) PubMed Google Scholar ) did not observe a ramp in dopamine neuron spiking may be due to the fact that the lateral region of the VTA was targeted in that study, underscoring the importance of recording from a matching pair of somata and axons.
Our study suggests that cues that indicate a gradual increase in proximity to reward play a key role in generating ramping signals. What then explains the difference between tasks in which dopamine signals ramp up or not? In reinforcement learning, values are computed based on the current “state” of the world. In this framework, the state is collectively defined by various types of information, such as the location, the objects that are present there, and the elapsed time from salient events. In natural situations, the state is often ambiguous because of partial information the animal receives, and state uncertainty can alter the shape of value functions ( Babayan et al., 2018 3. Babayan, B.M. ∙ Uchida, N. ∙ Gershman, S.J. Belief state representation in the dopamine system Nat. Commun. 2018; 9 :1891 Crossref Scopus (53) PubMed Google Scholar ; Gershman and Uchida, 2019 24. Gershman, S.J. ∙ Uchida, N. Believing in dopamine Nat. Rev. Neurosci. 2019; 20 :703-714 Crossref Scopus (117) PubMed Google Scholar ; Ludvig et al., 2008 41. Ludvig, E.A. ∙ Sutton, R.S. ∙ Kehoe, E.J. Stimulus representation and the timing of reward-prediction errors in models of the dopamine system Neural Comput. 2008; 20 :3034-3054 Crossref Scopus (104) PubMed Google Scholar ; Starkweather et al., 2017 59. Starkweather, C.K. ∙ Babayan, B.M. ∙ Uchida, N. ... Dopamine reward prediction errors reflect hidden-state inference across time Nat. Neurosci. 2017; 20 :581-589 Crossref Scopus (106) PubMed Google Scholar ). The tasks we used in the present study are different from the delayed-reward tasks in terms of the structure of state uncertainty. In our virtual reality and moving-bar tasks, sensory inputs continuously provide information about the proximity to reward, indicating that the uncertainty about the current location (state) may stay constant or even decrease over time. In contrast, it is known that uncertainty about the proximity to reward increases proportionally with elapsed time without cues, following Weber’s law ( Gibbon et al., 1997 25. Gibbon, J. ∙ Malapani, C. ∙ Dale, C.L. ... Toward a neurobiology of temporal cognition: advances and challenges Curr. Opin. Neurobiol. 1997; 7 :170-184 Crossref Scopus (619) PubMed Google Scholar ). This difference in the structure of state uncertainty may result in different shapes of value functions between the tasks. It will be interesting to directly test these ideas theoretically ( Mikhael et al., 2019 45. Mikhael, J.G. ∙ Kim, H.R. ∙ Uchida, N. ... Ramping and state uncertainty in the dopamine signal bioRxiv. 2019; Crossref Scopus (0) Google Scholar ) and experimentally in the future.
Together with other evidence ( Watabe-Uchida et al., 2017 69. Watabe-Uchida, M. ∙ Eshel, N. ∙ Uchida, N. Neural Circuitry of Reward Prediction Error Annu. Rev. Neurosci. 2017; 40 :373-394 Crossref Scopus (203) PubMed Google Scholar ; Parker et al., 2016 49. Parker, N.F. ∙ Cameron, C.M. ∙ Taliaferro, J.P. ... Reward and choice encoding in terminals of midbrain dopamine neurons depends on striatal target Nat. Neurosci. 2016; 19 :845-854 Crossref Scopus (193) PubMed Google Scholar ; Howe and Dombeck, 2016 30. Howe, M.W. ∙ Dombeck, D.A. Rapid signalling in distinct dopaminergic axons during locomotion and reward Nature. 2016; 535 :505-510 Crossref Scopus (345) PubMed Google Scholar ; Menegas et al., 2017 43. Menegas, W. ∙ Babayan, B.M. ∙ Uchida, N. ... Opposite initialization to novel cues in dopamine signaling in ventral and posterior striatum in mice eLife. 2017; 6 :e21886 Crossref Scopus (144) PubMed Google Scholar , 2018 44. Menegas, W. ∙ Akiti, K. ∙ Amo, R. ... Dopamine neurons projecting to the posterior striatum reinforce avoidance of threatening stimuli Nat. Neurosci. 2018; 21 :1421-1430 Crossref Scopus (189) PubMed Google Scholar ), the present results reinforce the idea that dopamine signals in the VS resemble TD RPEs. Although dopamine neurons in this population exhibit some diversity ( Engelhard et al., 2019 18. Engelhard, B. ∙ Finkelstein, J. ∙ Cox, J. ... Specialized coding of sensory, motor and cognitive variables in VTA dopamine neurons Nature. 2019; 570 :509-513 Crossref Scopus (244) PubMed Google Scholar ; Kremer et al., 2020 36. Kremer, Y. ∙ Flakowski, J. ∙ Rohner, C. ... Context-Dependent Multiplexing by Individual VTA Dopamine Neurons J. Neurosci. 2020; 40 :7489-7509 Crossref Scopus (33) PubMed Google Scholar ), at least some of the observed variability can be understood within the framework of RPEs. In contrast, more globally, a much larger level of diversity exists across different regions of the striatum ( Cox and Witten, 2019 15. Cox, J. ∙ Witten, I.B. Striatal circuits for reward learning and decision-making Nat. Rev. Neurosci. 2019; 20 :482-494 Crossref Scopus (244) PubMed Google Scholar ; Watabe-Uchida and Uchida, 2018 68. Watabe-Uchida, M. ∙ Uchida, N. Multiple Dopamine Systems: Weal and Woe of Dopamine Cold Spring Harb. Symp. Quant. Biol. 2018; 83 :83-95 Crossref Scopus (30) PubMed Google Scholar ). Thus, the diversity of dopamine neurons is organized hierarchically. Looking at the diversity of dopamine signals in this hierarchical manner, it will be important to clarify whether relatively minor variations in dopamine signals within each subsystem have any functional significance. A recent study of distributional reinforcement learning indicates that relatively minor variability in RPE enables computational advantages ( Dabney et al., 2020 16. Dabney, W. ∙ Kurth-Nelson, Z. ∙ Uchida, N. ... A distributional code for value in dopamine-based reinforcement learning Nature. 2020; 577 :671-675 Crossref Scopus (213) PubMed Google Scholar ). Furthermore, it will be important to understand the computational principle by which each dopamine subsystem operates at a global level. Our experimental paradigms will be a powerful means by which to examine the nature of dopamine signals. A deeper understanding of the nature of dopamine signals will aid in addressing these questions in the future.

Section: STAR★Methods

REAGENT or RESOURCE SOURCE IDENTIFIER Bacterial and Virus Strains AAV5-CAG-FLEX-jGCaMP6m-WPRE-SV40 UPenn vector core N/A AAV9-hSyn-DA2m Vigene Biosciences N/A AAV5-EF1a-DIO-hChR2(H134R)-EYFP UNC Vector Core N/A Experimental Models: Organisms/Strains Mouse: B6.SJL-Slc6a3 tm1.1(cre)Bkmn /J The Jackson Laboratory Jax #006660; RRID:IMSR_JAX:006660 Mouse: B6.Cg-Gt(ROSA) 26Sortm9(CAG-tdTomato)Hze /J The Jackson Laboratory Jax #007909; RRID:IMSR_JAX:007909 Mouse: .C57BL/6 J The Jackson Laboratory Jax # 000664; RRID:IMSR_JAX:000664 Software and Algorithms VirMEn (Virtual Reality MATLAB Engine) Dmitriy Aronov https://pni.princeton.edu/pni-software-tools/virmen MATLAB (2018b for analysis, 2011b for VirMEn) MathWorks https://www.mathworks.com/ MClust software (version 4.3.02) A. David Redish http://redishlab.neuroscience.umn.edu/MClust/MClust.html Open Ephys GUI Open Ephys https://open-ephys.org/gui Other Isosol (Isoflurane, USP) Vedco N/A Ketoprofen (for analgesia) Patterson Veterinary Cat #07-803-7389 Buprenorphine Patterson Veterinary Cat #07-850-2280 LRS-0473 DPSS Laser System LaserGlow Technologies Cat #R471003FX Sandvik Kanthal HP Reid Precision Fine Tetrode Wire Sandvik Cat #PF000591 Mono Fiber-optic Cannulas Doric Lenses MFC_200/245-0.53_5mm_MF1.25_FLT 32channel amplifier board Intan Technologies RHD2132 Open Ephys Acquisition Board Open Ephys https://open-ephys.org/acq-board Open table in a new tab
Further information and requests for resources and reagents should be directed to and will be fulfilled by the Lead Contact, HyungGoo Kim ( HyungGoo.R.Kim@gmail.com ).
This study did not generate new unique reagents.
Data and analysis code will be available in some form for purpose of reproducing or extending the analysis. MATLAB codes for data visualizations can be found at https://github.com/hkim09/libkm .
A total of 69 adult mice were used in the experiments. Thirty-six adult male mice were used for the experiments using calcium indicator (GCaMP). Twenty-nine mice were heterozygous for the gene expressing the Cre recombinase under the control of the promoter of the dopamine transporter (DAT) gene ( Bäckman et al., 2006 4. Bäckman, C.M. ∙ Malik, N. ∙ Zhang, Y. ... Characterization of a mouse strain expressing Cre recombinase from the 3′ untranslated region of the dopamine transporter locus Genesis. 2006; 44 :383-390 Crossref Scopus (293) PubMed Google Scholar ) (DAT-Cre or B6.SJL-Slc6a3 tm1.1(cre)Bkmn /J mice; The Jackson Laboratory; RRID:IMSR_JAX:006660). Seven mice were the result of a cross between DAT-Cre mice and a tdTomato transgenic line such that they were heterozygous for DAT-Cre and also heterozygous for tdTomato (Gt(ROSA) 26Sortm9(CAGtdTomato)Hze , Jackson Laboratory) ( Madisen et al., 2010 42. Madisen, L. ∙ Zwingman, T.A. ∙ Sunkin, S.M. ... A robust and high-throughput Cre reporting and characterization system for the whole mouse brain Nat. Neurosci. 2010; 13 :133-140 Crossref Scopus (4477) PubMed Google Scholar ). We did not observe a difference in results between these mice, thus results were combined. Six adult C57/BL6J DAT-Cre male mice were used for GFP control experiments. Ten adult C57/BL6J wild-type male mice were used for the experiments using the dopamine sensor. Four adult C57/BL6J DAT-Cre male mice were used for the experiments using rabies expressing GCaMP. Thirteen adult C57/BL6J DAT-Cre male mice were used for electrophysiological recording experiments. All mice were backcrossed for > 5 generations with C57/BL6J mice. Animals were singly housed on a 12 hr dark/12 hr light cycle (dark from 07:00 to 19:00). All procedures were performed in accordance with the National Institutes of Health Guide for the Care and Use of Laboratory Animals and approved by the Harvard Animal Care and Use Committee.
To prepare animals for recording, we performed a single surgery with three key components: (1) injection of an adeno associated virus (AAV) that expresses GCaMP in the presence of Cre recombinase (AAV-FLEX-GCaMP) into the midbrain, (2) head-plate installation, and (3) implantation of one or more optical fibers into the striatum ( Babayan et al., 2018 3. Babayan, B.M. ∙ Uchida, N. ∙ Gershman, S.J. Belief state representation in the dopamine system Nat. Commun. 2018; 9 :1891 Crossref Scopus (53) PubMed Google Scholar ; Menegas et al., 2017 43. Menegas, W. ∙ Babayan, B.M. ∙ Uchida, N. ... Opposite initialization to novel cues in dopamine signaling in ventral and posterior striatum in mice eLife. 2017; 6 :e21886 Crossref Scopus (144) PubMed Google Scholar ). At the time of surgery, all mice were 2–4 months old. All surgeries were performed under aseptic conditions with animals anesthetized with isoflurane (1- 2% at 0.5 - 1.0 L/min). Analgesia (ketoprofen for post-surgery treatment, 5 mg/kg, I.P.; buprenorphine for pre-operative treatment, 0.1 mg/kg, I.P.) was administered for 3 days following each surgery. We removed the skin above the surface of the brain and dried the skull using air. To express GCaMP specifically in dopamine neurons, we unilaterally injected 250 nL of AAV5-CAG-FLEX-GCaMP6m (1 × 10 12 particles/ml, Penn Vector Core) into both the VTA and SNc (500 nL total). To target the VTA, we made a small craniotomy and injected virus at bregma 3.1, lateral 0.6, depths 4.4 and 4.1 mm. To target SNc, we injected virus at bregma 3.3, lateral 1.6, depths 3.8 and 3.6 mm. Virus injection lasted several minutes, and then the injection pipette was slowly removed over the course of several minutes.
We then installed a head-plate for head-fixation by gluing a head-plate onto the top of the skull (C&B Metabond, Parkell). We used ring-shaped head-plates to ensure that the skull above the striatum would be accessible for fiber implants. Finally, during the same surgery, we also implanted optical fibers into the VS (nucleus accumbens core). For a subset of animals, we also implanted fibers into dorsomedial or dorsolateral striatum. To do this, we first slowly lowered optical fibers (200 μm diameter, Doric Lenses) into the striatum using a fiber holder (SCH_1.25, Doric Lenses). The coordinates we used for targeting were bregma 1.0, lateral 1.1, depth 4.1 mm. Once fibers were lowered, we first attached them to the skull with UV-curing epoxy (Thorlabs, NOA81), and then a layer of black Ortho-Jet dental adhesive (Lang Dental, IL). After waiting for fifteen minutes for this glue to dry, we applied a small amount of rapid-curing epoxy (A00254, Devcon) to attach the fiber cannulas to the underlying glue and head-plate. After waiting for fifteen minutes for the epoxy to cure, the surgery was completed.
The above results suggest that the somewhat larger ramping of axonal calcium signals may be due to the slow kinetics of calcium signals compared to spiking activities. Furthermore, the ramping in spiking activity at the cell body suggests that ramping axonal calcium activities in the VS may originate from ramping somatic spiking. If these were true, then calcium signals measured at the cell bodies of dopamine neurons should also exhibit a similar level of ramping as those at the axons, as well as the features of RPEs that we observed in the above experiments. For that purpose, we recorded calcium signals from dopamine neurons in the VTA. The injection of virus was done in the same way as the recordings in the VS. For recording in the VTA, we placed a fiber at bregma 3.1, lateral 0.6, depths 4.1 mm.
Dopamine neurons projecting to the nucleus accumbens core were retrogradely labeled by a modified rabies virus that expresses a calcium indicator ( Reardon et al., 2016 52. Reardon, T.R. ∙ Murray, A.J. ∙ Turi, G.F. ... Rabies Virus CVS-N2c(ΔG) Strain Enhances Retrograde Synaptic Transfer and Neuronal Viability Neuron. 2016; 89 :711-724 Full Text Full Text (PDF) Scopus (180) PubMed Google Scholar ). Adult male DAT-Cre mice were first injected with 0.5μL AAV5-FLEX-TVA-mCherry (Custom AAV preparation by UNC vector core) to the left medial VTA (AP −3.05, ML 0.4, depth 4.3-4.5 mm). Two weeks later, mice were injected with 0.5μL of a 1:2 mixture of AAV1-CAG-BFP (Custom AAV preparation by UNC vector core) and CVS-N2c ΔG -GCaMP6f (EnvA) (provided by Catherine Dulac’s laboratory, obtained from HHMI Janelia) to the left VS (AP +1.1, ML +1.0, depth 3.85-3.95 mm) and then an optical fiber was implanted within the left medial VTA (AP −3.05, ML 0.4, depth 4.35 mm).
To directly examine whether the dopamine concentration in the VS represents RPE or value, we performed direct measurements of dopamine using a genetically encoded dopamine sensor (a second-generation sensor, GRAB DA2m ) ( Sun et al., 2018, 2020 60. Sun, F. ∙ Zeng, J. ∙ Jing, M. ... A Genetically Encoded Fluorescent Sensor Enables Rapid and Specific Detection of Dopamine in Flies, Fish, and Mice Cell. 2018; 174 :481-496.e19 Full Text Full Text (PDF) Scopus (483) PubMed Google Scholar 61. Sun, F. ∙ Zhou, J. ∙ Dai, B. ... Next-generation GRAB sensors for monitoring dopaminergic activity in vivo Nat. Methods. 2020; 17 :1156-1166 Crossref Scopus (207) PubMed Google Scholar ). This dopamine sensor (GRAB DA2m ) was expressed in neurons in the VS, and fluorescent signals were measured through an optical fiber implanted in the VS ( Figure 6 E). Surgical procedures up to virus injection were the same as GCaMP injections described above. Instead of GCaMP, we injected 400 nL of AAV9-hSyn-DA2m (Vigene bioscience) into the VS (bregma 1.0, lateral 1.1, depths 4.2 and 4.1mm). Once injection was completed, we implanted an optical fiber and head plate in the same way as the surgery for GCaMP recording.
We performed two surgeries, both stereotactically targeting the left VTA (from bregma: 3.1 mm posterior, 0.6 mm lateral, 4.2 mm ventral). In the first surgery, we injected 500 nL of AAV5 carrying an inverted ChR2-encoding sequence (H134R) fused to the sequence expressing the fluorescent reporter eYFP and flanked by double loxP sites (AAV5-DIO-ChR2-EYFP) ( Tsai et al., 2009 66. Tsai, H.-C. ∙ Zhang, F. ∙ Adamantidis, A. ... Phasic firing in dopaminergic neurons is sufficient for behavioral conditioning Science. 2009; 324 :1080-1084 Crossref Scopus (939) PubMed Google Scholar ). We previously showed that the expression of this virus is highly selective and efficient in dopamine neurons ( Cohen et al., 2012 14. Cohen, J.Y. ∙ Haesler, S. ∙ Vong, L. ... Neuron-type-specific signals for reward and punishment in the ventral tegmental area Nature. 2012; 482 :85-88 Crossref Scopus (899) PubMed Google Scholar ). After 2 weeks, we performed the second surgery to implant a head plate and custom-built microdrive containing 8 tetrodes and an optical fiber.
Virtual environments were displayed on three liquid crystal display (LCD) monitors with thin frames (width 53 cm, height 30 cm) that were placed on the left, front, and right side of animals ( Chen et al., 2013a 11. Chen, G. ∙ King, J.A. ∙ Burgess, N. ... How vision and movement combine in the hippocampal place code Proc. Natl. Acad. Sci. USA. 2013; 110 :378-383 Crossref Scopus (226) PubMed Google Scholar ; Harvey et al., 2009 29. Harvey, C.D. ∙ Collman, F. ∙ Dombeck, D.A. ... Intracellular dynamics of hippocampal place cells during virtual navigation Nature. 2009; 461 :941-946 Crossref Scopus (654) PubMed Google Scholar ). A workstation computer with a high-performance graphics card (NVIDIA Quadro K2200) was used to present visual images. ViRMEn software ( Aronov and Tank, 2014 2. Aronov, D. ∙ Tank, D.W. Engagement of neural circuits underlying 2D spatial navigation in a rodent virtual reality system Neuron. 2014; 84 :442-456 Full Text Full Text (PDF) Scopus (166) PubMed Google Scholar ) was used to generate virtual objects and render visual images using perspective projection. No dropping of image frames was confirmed by measuring intervals in the inter-frame callback function, and by photodiode measurements while a test program alternated the brightness of the screen every frame.
Animals were head-restrained at the center of three monitors, 7.5 cm above the bottom of the screen. Mice were placed on a cylindrical styrofoam treadmill (diameter 20.3 cm, width 10.4 cm). The rotational velocity of the treadmill was encoded using a rotary encoder. The output pulses of the encoder were converted into continuous voltage signals using a customized Arduino program running on a microprocessor (Teensy 3.2).
Water reward was given through a water spout located in front of the animal’s mouth. Licking tongue movements were monitored using an infrared sensor (OPB819Z, TT Electronics). Voltage signals from the rotary encoder and the lick sensor were digitized into a PCI-based data-acquisition system (PCIe-6323, National Instruments) installed on the visual stimulation computer. Timing and amount of water were controlled through a micro-solenoid valve (LHDA 1221111H, The Lee Company) and switch (2N7000, On Semiconductor). Analog output TTL pulse was generated from the visual stimulation computer to deliver reward to the animals.
Animals were trained in a virtual linear track ( Figure 1 A; length of 150 arbitrary units, a.u., and width of 30 a.u.). The maze was composed of a starting platform and a corridor with walls on both sides. The walls have four different texture patterns to help animals recognize a position in the virtual space ( Video S1 ).
We first trained animals on the standard approach-to-target task to learn the association between target location and reward. Once the animals learned the task, we ran a series of tasks with test trials to examine the nature of dopamine signals. We typically ran each task for two consecutive days (with zero- or one-day break). A daily session started with 5-10 standard trials to help animals remember the task before presenting any test trials. Unless otherwise noted, unexpected reward (5 μl) was given during the inter-trial interval on 3%–6% of trials.
The session started in a dark gray background. Trials started with the presentation of the visual scene with the animal placed at the starting position (0 a.u.). After a random delay (1 s offset plus a random delay drawn from a modified exponential distribution with a mean of 1.5 s and cutoff of 3.5 s), the visual scene started moving forward. The velocity linearly increased for 1 s until it reached 13 a.u./s, after which the velocity was maintained to be constant until the animal reached the target position (97 a.u.). A drop of water reward (5 μl) was delivered through a water spout that was placed in front of the animal’s mouth. No reward omission trials were used. Once the reward was given, the visual stimulus was turned off after a random delay (drawn from an exponential distribution with a mean of 1 s, to which a 1 s offset was added). Delay was re-drawn if it exceeded 4 s. Inter-trial interval (ITI) was drawn from an exponential distribution with a mean of 3 s, to which a 3.5 s offset was added. ITI was re-drawn if it exceeded 10 s.
The following three types of test conditions were randomly interleaved with the standard condition. Each test condition comprised 20% of trials. 1 Long teleport : when the animal reached a predefined position (40 a.u.), it was teleported to a position closer to the reward (70 a.u.). At the time of teleport, the screens were briefly (93 ms) blanked to black. 2 Short teleport : when the animal reached another predefined position (65 a.u.), it was teleported to the same destination (70 a.u.). 3 Pause : when the animal reached this destination (70 a.u.), the progression of the scene was paused for 5 s, after which the scene movement resumed.
In all trials, the animal received a reward when it reached the same goal location (97 a.u.).
The following three types of teleport conditions were randomly interleaved with the standard condition with the frequency of all teleport conditions being 33%–40% in total. On a fraction of trials, when the animal reached one of the three teleport positions (5, 25, and 45 a.u.), it was teleported by the same distance (30 a.u.) forward to the location closer to the goal location (35, 55 and 75 a.u., respectively). The screens were briefly (93 ms) blanked to black at the time of teleport. Scene progression was 20% slower than that it had been during training, except for the first four animals. Data from these four animals were excluded from the population time courses but included in other statistical analyses.
On a fraction of trials (20%), the progression of the scene was twice as fast as in the standard condition. On some other trials (20%), the progression was half as fast as in the standard condition. The rest of the trials were the same as the standard approach-to-target task. The acceleration of the scene in the manipulated condition was identical to the standard condition (13 a.u./s 2 ).
No Reward control experiments. We tested whether the transient response to teleport is due to the short blackout or the abrupt change of visual scene in the absence of a reward context. Before training began with reward in the standard approach-to-target condition, a subset of animals performed Experiment 1 (n = 7 mice), Experiment 2 (n = 13 mice), and Experiment 3 (n = 13 mice) without reward at the target location. Unexpected rewards were delivered during the inter-trial intervals on 10% of trials. We ran one session for each protocol (70-100 trials), one or two control experiments a day.
In the speed manipulation task (Experiment 3), animals might use the speed of scene movement as a cue for an early or late reward (i.e., time to reward). To exclude the possibility that the dopamine signals are driven by time to reward signaled by scene movement speeds. we dynamically changed the speed of scene within a trial while maintaining the total time between trial start and reward ( Figure S3 I) constant. We used three trial types: (1) accelerating, (2) decelerating, and (3) standard conditions. The instantaneous speeds followed the equations below ( Kim et al., 2015 34. Kim, H.R. ∙ Angelaki, D.E. ∙ DeAngelis, G.C. A functional link between MT neurons and depth perception based on motion parallax J. Neurosci. 2015; 35 :2766-2777 Crossref Scopus (20) PubMed Google Scholar ): 𝑣 1 ⁡ ( 𝑡 ) = s i n ⁡ ( 𝑡 + 𝑡 𝑜 ⁢ 𝑓 ⁢ 𝑓 2 ⁢ 𝑡 0 ∗ 2 ∗ 𝑝 ⁢ 𝑖 + 𝜃 𝑖 ) v 2 ⁢ ( t ) = 𝑣 𝑎 ⁢ 𝑚 ⁢ 𝑝 ⁡ ( | 𝑣 1 ⁡ ( 𝑡 ) | 𝑘 ⁢ 𝑠 ⁢ 𝑖 ⁢ 𝑔 ⁢ 𝑛 ⁡ ( 𝑣 1 ⁡ ( 𝑡 ) ) + 1 ) + 𝑣 𝑜 ⁢ 𝑓 ⁢ 𝑓 , 𝑖 G ⁡ ( t ) = e x p ⁡ ( − ( ( 𝑡 − 𝑡 0 ) 𝜎 𝑣 ⁡ 𝑒 ⁢ 𝑙 ) 𝑛 𝑣 ⁡ 𝑒 ⁢ 𝑙 ) ⁢ v ⁡ ( t ) = 𝐺 ⁡ ( 𝑡 ) ∗ 𝑣 2 ⁡ ( 𝑡 ) where i = 1 , 2 f o r t h e t w o o p p o s i t e p h a s e s , t 0 = 6 , 𝑡 𝑜 ⁢ 𝑓 ⁢ 𝑓 = 1 . 5 , 𝜎 𝑣 ⁢ 𝑒 ⁢ 𝑙 = 5 , 𝑛 𝑣 ⁢ 𝑒 ⁢ 𝑙 = 1 2 , 𝑣 𝑎 ⁢ 𝑚 ⁢ 𝑝 = 1 0 , 𝑣 𝑜 ⁢ 𝑓 ⁢ 𝑓 , 1 = 4 . 3 0 9 , 𝑣 𝑜 ⁢ 𝑓 ⁢ 𝑓 , 2 = 4 . 6 4 1 , θ 1 = 0 , 𝜃 2 = 𝜋 , k = 0.7143. The animals either decelerate (i = 1) or accelerate (i = 2) near the reward location while the trial duration is identical to the standard condition ( Figure 2 M).
We tested whether the abrupt change of visual scene caused a transcient excitation. Once the animals were fully trained for the standard linear track (Track 1; Figure 4 A, left), we introduced the second linear track (Track 2; Figure 4 A, right) in which wall patterns were distinct from Track 1 ( Video S4 ). In both tracks, animals obtained the same amount of water (4 μL) at the end of the tracks (97 a.u.). On 60% of the trials, mice performed the task in Track 1. On 3/8 of the trials in each track, mice were teleported to the same position in the other tack ( Figure 4 B; 55 a.u.).
After collecting data in Experiment 5a, we used the same animals to confirm that a forward teleport elicited a transcient excitation in the same session ( Figure 4 E). Mice started trials in Track 1 on 50% of the trials and started trials in Track 2 on the rest of trials. On 1/3 of the trials initiated in Track 1, mice were teleported forward from 40 a.u. to 70 a.u. On the other 1/3 of the trials in Track 1, mice were teleported from Track 1 to Track 2 (60 a.u.). Mice were neither teleported forward nor to Track 1 when trials were started in Track 2.
Animals obtained 2 μL in Track 1 and 12 μL in Track 2 ( Figure 4 H). On a faction of trials (1/6 for each condition), animals were teleported forward (40 a.u.), teleported from Track 1 to Track 2 (60 a.u.), or teleported from Track 2 to Track 1 (60 a.u.). Forward-teleport trials were not used for analyses.
We randomly interleaved the standard, forward teleport (from 40 a.u. to 70 a.u.), and backward teleport (from 70 a.u. to 40 a.u.; Figure 4 K) conditions. Each manipulated condition comprised 20% of trials.
We alternated blocks of 25 trials to switch between a small-reward (2.25 μl/trial) and a large-reward (10 μl/trial) conditions ( Figure 4 N). No explicit cue was given to notify a block switch. On the first day of Experiment 7, we randomly chose whether the first block was a small- or large-reward block. The other reward size was used for the first block on the next day. On a fraction of trials (20%), we teleported the animals from 45 a.u. to 75 a.u.
In the main experiments describe above (Experiments 1-7), the scene movement was decoupled from the animal’s movement, and reward was delivered regardless of the animal’s action (“open-loop” or Pavlovian). In this paradigm, the scene movement was coupled to the animal’s locomotion and the animal was required to locomote a predefined distance to obtain reward (“closed loop” or operant). The virtual environment was identical to Track 1, except that the length of the track was increased from 150 a.u. to 1000 a.u. The modification was made to prevent the animals from using looming cues at the end of the track to estimate their positions.
After habituation in the experimental setup, mice were trained in a ‘running exercise’ protocol for 1-2 days. In this training, mice obtained 3 μL of water with an interval reversely proportional to their running speed, with the lower bound of 1.5 s. After mice achieved a consistent running behavior (mice are in locomotion state for more than 30% of the entire session and average running speed is greater than 5 cm/s), we introduced a closed-loop linear track in a staircase manner. At a trial start, mice were placed on one of the eight starting positions (0, 20, 30, 40, 50, 60, 70, 75 a.u.; the reward location, 97 a.u.). On the first day of training, trials were started with the starting position (75 a.u.) that is the closest to the reward location. The starting position of the next trial is probabilistically determined depending on the performance of the current trial: after a successful trial, the mouse was located one step farther from the reward location, with probability of 0.2. After an unsuccessful trial, the mouse was located one step closer to the reward location with the probability of 0.5. Otherwise, the starting location remained the same in the next trial. Trials were aborted and marked unsuccessful if either the animal did not leave the start location in 20 s or the animal did not reach the target position in 40 s after leaving the start location. From the second day of training, the start location of the first trial was set to be two steps closer than the start location with a stable performance in the previous session. Mice gradually learned to run consistently through this probabilistic staircase procedure.
Once the animal achieved stable running behavior at the starting position of 0 a.u., we ran an adaptive gain-adjustment protocol. This protocol adaptively changed the visual gain of indivual aniamls such that the interval between locomotion onset and reward delivery (locomotion_duration) became similar to that in the open loop condition (7.5 s). Each trial, we calculated the target gain: T ⁢ a ⁢ r ⁢ g ⁢ e ⁢ t g ⁢ a ⁢ i ⁢ n = l ⁢ o ⁢ c ⁢ o ⁢ m ⁢ o ⁢ t ⁢ i ⁢ o ⁢ n _ d ⁢ u ⁢ r ⁢ a ⁢ t ⁢ i ⁢ o ⁢ n / 7 . 5 and updated the gain adaptively with a learning rate (α i ) that exponentially decreases over trials: g a i n i + 1 = g a i n i + α i ∗ ( t a r g e t g a i n i − 1 ) 𝛼 𝑖 = 0 . 1 ∗ e x p ⁡ ( − 𝑡 ⁢ 𝑟 ⁢ 𝑖 ⁢ 𝑎 ⁢ 𝑙 𝑛 ⁢ 𝑢 ⁢ 𝑚 ⁢ 𝑏 ⁢ 𝑒 ⁢ 𝑟 / 7 0 ) Once a converging adaptive gain was obtained in one or two sessions, the gain was fixed for further training and experiments.
Once the animals showed stable performance (success rate > 85%) and anticipatory licking, the mice were recorded in the standard experiments and the experiments with test trials (Experiments 1 and 3). After testing, some mice were further tested in Experiment 8 as described below.
We conducted the teleport and pause experiment (Experiment 1) and the speed-manipulation experiment (Experiment 3) to examine the nature of dopamine signals in a closed-loop virtual reality environment. The experimental manipulations (e.g., the proportion of manipulated trials, the dynamics of position in teleport and pause) were identical to the open-loop experiments.
To examine the role of cues that indicate the proximity to reward in generating ramping dopamine signals, we manipulated the visual cues in the standard virtual reality task. We prepared two linear tracks that differed in the wall pattern compared to the original track (Track 1). Track 3 contained a regular pattern of black spots on blue walls (patterned; Figure 7 E, left bottom; Experiment 8a), which eliminated cues associated with specific locations in the linear track, but created an optic flow. Track 4 consisted of solid-blue walls without the floor pattern, which generated no optic flow in the visual scene (solid-colored; Figure 7 F, left bottom; Experiment 8b). Animals were required to run the same distance to obtain a reward on Tracks 1, 3 and 4. The test tracks (Track 3 or 4) were randomly interleaved (25% - 33%) with the standard track (Track 1) during training and recording.
In previous experiments from our laboratory, ramping dopamine neuron activity was not observed in delayed-reward tasks in which reward was delivered with a fixed delay after a cue (e.g., Cohen et al., 2012 14. Cohen, J.Y. ∙ Haesler, S. ∙ Vong, L. ... Neuron-type-specific signals for reward and punishment in the ventral tegmental area Nature. 2012; 482 :85-88 Crossref Scopus (899) PubMed Google Scholar ; Starkweather et al., 2017 59. Starkweather, C.K. ∙ Babayan, B.M. ∙ Uchida, N. ... Dopamine reward prediction errors reflect hidden-state inference across time Nat. Neurosci. 2017; 20 :581-589 Crossref Scopus (106) PubMed Google Scholar ). We sought to compare the activity of dopamine neurons in the present task to the activity of dopamine neurons in a task in which ramping dopamine neuron activity was not previously observed. One difference between the present and previous experiments is the timescale: whereas there was a relatively long time delay (∼7 s) between scene movement onset and reward in the present study, the previous studies have used relatively short delays (e.g., 2-3 s) (but see Fiorillo et al., 2008 21. Fiorillo, C.D. ∙ Newsome, W.T. ∙ Schultz, W. The temporal precision of reward prediction in dopamine neurons Nat. Neurosci. 2008; 11 :966-973 Crossref Scopus (228) PubMed Google Scholar ; Kobayashi and Schultz, 2008 35. Kobayashi, S. ∙ Schultz, W. Influence of reward delays on responses of dopamine neurons J. Neurosci. 2008; 28 :7837-7846 Crossref Scopus (297) PubMed Google Scholar ). Once the mice were fully trained for the approach-to-target task, a subset of mice used for single neuron recordings were trained in a classical conditioning (a delayed-reward task) using odor cues (6 out of 13 mice). We used the same behavioral apparatus with three monitors as the virtual reality experiments, additionally equipped with a custom-made olfactometer (odor delivery machine) ( Uchida and Mainen, 2003 67. Uchida, N. ∙ Mainen, Z.F. Speed and accuracy of olfactory discrimination in the rat Nat. Neurosci. 2003; 6 :1224-1229 Crossref Scopus (520) PubMed Google Scholar ). A trial start was signaled by a brief (0.25 s) flash of green background on the computer monitors. 1.25 s after the onset of trial start cue, an odor was delivered for 0.5 s, followed by a delivery of water reward. Different odors indicated different delays between an odor onset and reward (0.6 s, 1.5 s, 3.75 s, 9.375 s for Odors A, B, C and D, respectively). Only trials with Odor C and D are reported here to match the timescales. Inter-trial intervals were adjusted for each odor cue such that the intervals between trial start signals (flash of light) were similar across odor cues on average, and were between 17 and 20 s. Animals showed anticipatory licking after three to seven days of training. Once we found a light-identified neuron on mice that were fully trained for both the linear track task and the odor-reward association task, we first ran 70-90 trials of the odor-reward association task and then ran a series of standard and manipulation experiments in the linear track. For more direct comparisons to the virual reality tasks, we only show results using two odors (Odors C and D) which have similar delays as in the linear track tasks.
Odors were delivered similar to previous studies ( Uchida and Mainen, 2003 67. Uchida, N. ∙ Mainen, Z.F. Speed and accuracy of olfactory discrimination in the rat Nat. Neurosci. 2003; 6 :1224-1229 Crossref Scopus (520) PubMed Google Scholar ). Each odorant was dissolved in mineral oil at 1/10 dilution. 30 μl of odor solution was placed on a glass fiber filter paper. Filtered air was run through the filter paper to produce a total flow rate of 1 L/min. Odorants used included isoamyl acetate, (+)-carvone, 1-hexanol, p-cymene, ethyl butyrate, 1-butanol, limonene, dimethoxybenzene, caproic acid, 4-heptanone and eugenol. A set of odorants used for each mouse was assigned randomely.
We used the same three-monitor display setup as in our linear track tasks. The background was gray. A black ring-shaped object was used to render black bars on the three screens in the virtual environment. The object (2.5 cm vertical thickness) moved vertically at a constant speed to indicate reward proximity ( Video S5 ).
A black bar was initially presented at the top of the screen. After a random inter-trial interval, the bar started to move from the top to the bottom of the screen at a constant speed (3.7 cm/s). When the bar reached a goal position (25 cm from the top of the screen, 6.7 s after the movement onset of the bar), a drop of water (5 μl) was delivered. After a random delay (the same as the 1D maze task), the bar was shifted back to the original starting position. The screen was kept on during the inter-trial interval.
On some fraction of trials (12.5%, respectively), when the position of the bar reached one of two positions on the screen (10.9 cm or 16.25 cm from the top of the screen), the bar was abruptly shifted downward by 6.25 cm or 0.93 cm, respectively, and maintained movement with constant speed. On another 12.5% of trials, the bar movement was paused for 5.0 s, after which the movement resumed. These test conditions were randomly interleaved with the standard condition.
When the center of the bar reached 1.56, 6.9, or 12.18 cm from the top of the screen (0.4 s, 1.37 s, or 2.78 s from bar movement onset, respectively), the bar shifted its position by 6.6 cm (12.5% of total trials, respectively). The teleport conditions were randomly interleaved with the standard condition.
The movement of the bar was twice as fast as the standard condition (20%) or half as fast as the standard condition (20%).
The vertical order in the table below represents approximate order of experiments for each animal with the identity of each animal indicated by a unique number in the Animal column. The number of animals vary across experiments, and not all animals were subjected to all possible experiments, because (1) some experiments were developed later than others (e.g., Experiment 1 was established later than Experiment 2 and 3), (2) some technical issues prevented us from executing further experiments (e.g., overall decay of signals after weeks of experiments or inadvertent removal of headplate etc.), or (3) we deliberately distributed animals across different experiments to ensure enough sample size for each experiment.
A total of 16 animals (Mouse 1-16) were used for the main experiments (GCaMP fluorometry in VS, Experiment 1-3 in the virtual linear track and the moving bar tasks). Four of the 16 animals (Mouse 13-16) had optical fibers implanted both in VS and VTA.
A total of 6 mice (Mouse 13-15, 17-19) were used for GCaMP fluorometry in VTA. Three of the 6 mice had optical fiber also in the VS. Mouse 18 and 19 were further tested with Experiment 5 and 6 (see below).
A total of 6 mice (Mouse 20-25) were used for GFP control experiments.
A total of 6 mice (Mouse 18, 19, 26-29) were used for Experiment 5 and 6 with GCaMP fluorometry in VS. Mouse 29 was further tested with Experiment 4 (see below).
A total of 5 mice (Mouse 29-31, 33, 34) were used for Experiment 4 with GCaMP fluorometry in VS. A total of 4 mice (Mouse 30-33) were used for Experiment 7 GCaMP fluorometry in VS. Note that two mice (Mouse 30 and 31) were tested in both Experiment 4 and 7.
We used an independent set of 8 mice (Mouse 35-42) for closed-loop (operant contingency) experiments.
We used an independent set of 10 mice (Mouse 43-52) for experiments with a dopamine sensor.
We used an independent set of 4 mice (Mouse 53-56) for experiments using rabies virus. One mouse (Mouse 53) did not learn the task before an inadvertent termination of experiments due to COVID19 shutdown. Mouse 53 was, therefore, used only for anatomical investigation. Mouse 54-56 were used for fiber fluorometry experiments as well as anatomical investigation.
A total of 13 mice (Mouse 57-69) were used for electrophysiological recording. Eight of these mice (Mouse 61-66, 68, 69) were additionally examined in the delayed reward task with odor cues. The recording sites of 10 mice (Mouse 57-64, 68, 69) were verified to be in the VTA while those of 3 mice (Mouse 65-67) contained the SNc. We collected the following number of neurons from each animal: 2 neurons from Mouse 57 (medial-lateral coordinate [ML] = 509 μm), 13 neurons from Mouse 58 (ML = 417 μm), 1 neuron from Mouse 59 (ML = 320 μm), 2 neurons from Mouse 60 (ML = 651 μm), 37 neurons from Mouse 61 (ML = 517 μm), 13 neurons from Mouse 62 (ML = 702 μm), 1 neuron from Mouse 63 (ML = 798 μm), 6 neurons from Mouse 64 (ML = 846 μm), 9 neurons from Mouse 65 (ML = 1048 μm), 5 neurons from Mouse 66 (ML = 936 μm), 6 neurons from Mouse 67 (ML = 1038 μm), 3 neurons from Mouse 68 (ML = 567 μm), and 24 neurons from Mouse 69 (ML = 531 μm).
Protocol Animal Figure VS, GCaMP Track 1, standard training 1-16 Figures 1 K, 1L, and S2 E–S2J No-reward context, Experiment 3, 2, or 1 5,6,7,8,9,13,14,15,16 Figure S4 E Experiment 3 (Speed) 1-15 Figures 2 I–2L, S3 E, and S3F Experiment 2 (3 teleports) 1-15 Figures 2 E–2H, S3 C, and S3D Experiment 1 (Teleport and pause) 5-15 Figures 2 A–2D, S3 A, and S3B Experiment 7 (Reward size manipulation) 2-11 Figures 4 N–4P Moving-bar, standard condition 1,3,5,6,7,8,9,10,13,14,15,16 Figures S7 K and S7L Moving-bar, Experiment 3 (Speed) 1,3,5,6,7,8,9,13,14,15,16 Figures 7 I and S7 O Moving-bar, Experiment 2 (3 teleports) 3,5,6,7,8,9,13,14,15,16 Figures 7 J and S7 N Moving-bar, Experiment 1 (Teleport and pause) 5,6,7,8,9,13,14,15,16 Figures 7 K and S7 M VTA, GCaMP Track 1, standard training 13-15, 17-19 Experiment 3 (Speed) 13,14,15,18,19 Figures 6 D and S6 G Experiment 2 (3 teleports) 13,14,15,17,18,19 Figures 6 C and S6 F Experiment 1 (Teleport and pause) 13,14,15,17,18,19 Figures 6 B and S6 E Moving-bar, standard condition 13,14,15,17,18,19 Moving-bar, Experiment 3 (Speed) 13,14,15,17,18,19 Figure S6 J Moving-bar, Experiment 2 (3 teleports) 14,15,17,18,19 Figure S6 I Moving-bar, Experiment 1 (Teleport and pause) 14,15,17,18,19 Figure S6 H VS, GFP Track 1, same as GCaMP VS main tasks 20-25 Figures 1 M, 1N, S4 F, and S4G VS, GCaMP Track 1, training 18,19,26,27,28,29 Experiment 6 (Forward & backward teleport) 18,19,26,27,28,29 Figures 4 K–4M and S4 L Experiment 5a (Teleport between tracks) 18,19,26,27,28,29 Figures 4 B–4D and S4 I Experiment 5b (Forward + between-track teleport) 18,19,26,27,28,29 Figures 4 E–4G and S4 J VS,GCaMP Experiment 4 (Dynamic speed manipulation) 29,30,31,33,34 Figures 2 M–2P and S3 G–S3I Experiment 7 (Reward size manipulation) 30,31,32,33 Figures 4 H–4J and S4 K VS, GCaMP Track 1, Close-loop training 35-42 Closed-loop, Track 1, standard 35-42 Figure S7 C Closed-loop, Experiment 3 (Speed) 35-41 Figures S7 E and S7I Closed-loop, Experiment 1 (Teleport and pause) 35-41 Figures S7 D and S7H Closed-loop, Experiment 8a (Scene manipulation) 36-40, 42 Figures 7 E, S7 F, and S7J Closed-loop, Experiment 8b (Scene manipulation) 36-40, 42 Figures 7 F, S7 G, and S7J VS, DA sensor Track 1, same as GCaMP VS main tasks 43-52 Figures 6 E–6H moving-bar, standard, Experiment 3, 1, 2 44,45,47-52 Figures 7 O–7Q VTA, GCaMP rabies anatomy 53-56 (rabies) Track 1, standard condition training 54,55,56 Figure S5 J VTA, ephys Track 1, standard training 57-69 Odor task 61-66, 68,69 (8/13 mice) Figures 7 A–7D, S7 A, and S7B Track 1, standard training (65-67: SNc mice) Figures 5 B–5E and S5 E Experiment 1 (Teleport and pause) Figures 5 K, 5P, and S5 O Experiment 3 (Speed), Figures 5 L and 5P Experiment 7 (Reward size manipulation) Open table in a new tab
Fluorescent signals from the brain were recorded using a custom-made fiber fluorometry (photometry) system as described in our previous studies ( Babayan et al., 2018 3. Babayan, B.M. ∙ Uchida, N. ∙ Gershman, S.J. Belief state representation in the dopamine system Nat. Commun. 2018; 9 :1891 Crossref Scopus (53) PubMed Google Scholar ; Menegas et al., 2017 43. Menegas, W. ∙ Babayan, B.M. ∙ Uchida, N. ... Opposite initialization to novel cues in dopamine signaling in ventral and posterior striatum in mice eLife. 2017; 6 :e21886 Crossref Scopus (144) PubMed Google Scholar ). The blue light (473 nm) from a diode-pumped solid-state laser (DPSSL; 80–500 μW; Opto Engine LLC, UT, USA) was attenuated through a neutral density filter (4.0 optical density, Thorlabs, NJ, USA) and coupled into an optical fiber patchcord (400 μm, Doric Lenses) using a 0.65 NA microscope objective (Olympus). The patchcord connected to the implanted fiber was used to deliver excitation light to the brain and to collect the fluorescence emission signals from the brain. The fluorescent signal from the brain was spectrally separated from the excitation light using a dichroic mirror (T556lpxr, Chroma), passed through a bandpass filter (ET500/50, Chroma), focused onto a photodetector (FDS100, Thorlabs) and amplified using a current preamplifier (SR570, Stanford Research Systems). Acquisition from the red fluorophore (tdTomato) was simultaneously acquired (bandpass filter ET605/70 nm, Chroma) but was not used for further analyses. The voltage signal from the preamplifier was digitized through a data acquisition board (PCI-e6321, National Instruments) at 1kHz and stored in a computer using a custom software written in LabVIEW (National Instruments).
Motion artifacts were examined using mice expressing GFP in dopamine neurons. We injected AAV5-FLEX-GFP in the VTA and SNc of DAT-Cre mice and collected behavior and fluorometry signals in the same way as the GCaMP animals. Raw voltage traces were qualitatively different from GCaMP, with no noticeable fluctuation with the same amplifier configuration. Although animals learned the tasks and acquired behaviors similar to the GCaMP animals, we observed no ramping. We observed neither phasic responses to teleports, nor any significant difference between test conditions.
We based recording techniques on previous studies ( Cohen et al., 2012 14. Cohen, J.Y. ∙ Haesler, S. ∙ Vong, L. ... Neuron-type-specific signals for reward and punishment in the ventral tegmental area Nature. 2012; 482 :85-88 Crossref Scopus (899) PubMed Google Scholar ; Kvitsiani et al., 2013 37. Kvitsiani, D. ∙ Ranade, S. ∙ Hangya, B. ... Distinct behavioural and network correlates of two interneuron types in prefrontal cortex Nature. 2013; 498 :363-366 Crossref Scopus (325) PubMed Google Scholar ; Lima et al., 2009 39. Lima, S.Q. ∙ Hromádka, T. ∙ Znamenskiy, P. ... PINP: a new method of tagging neuronal populations for identification during in vivo electrophysiological recording PLoS ONE. 2009; 4 :e6099 Crossref Scopus (271) PubMed Google Scholar ). We recorded extracellularly from the VTA using a custom-built, screw-driven containing eight tetrodes glued to a 200-μm optical fiber (ThorLabs). Tetrodes (Sandvik, Palm Coast, Florida) were glued to the fiber and clipped so that their tips extended 200–500 μm from the end of the fiber. We recorded neural signals with an Open Ephys recording system with Intan headstage (RHD2132, Intan technologies). Broadband signals from each wire were recorded continuously at 30 kHz. To extract spike timing, signals were band-pass-filtered between 300 and 6,000 Hz and sorted offline using MClust-4.3 (A.D. Redish). To be included in the dataset, a neuron had to be well isolated (a measure of unit isolation quality, L-ratio < 0.05) ( Schmitzer-Torbert and Redish, 2004 55. Schmitzer-Torbert, N. ∙ Redish, A.D. Neuronal activity in the rodent dorsal striatum in sequential navigation: separation of spatial and reward responses on the multiple T task J. Neurophysiol. 2004; 91 :2259-2272 Crossref Scopus (133) PubMed Google Scholar ). We also histologically verified recording sites by creating electrolytic lesions using 10–15 s of 30 μA direct current.
To unambiguously identify dopamine neurons, we used ChR2 to observe laser-triggered spikes ( Cohen et al., 2012 14. Cohen, J.Y. ∙ Haesler, S. ∙ Vong, L. ... Neuron-type-specific signals for reward and punishment in the ventral tegmental area Nature. 2012; 482 :85-88 Crossref Scopus (899) PubMed Google Scholar ; Lima et al., 2009 39. Lima, S.Q. ∙ Hromádka, T. ∙ Znamenskiy, P. ... PINP: a new method of tagging neuronal populations for identification during in vivo electrophysiological recording PLoS ONE. 2009; 4 :e6099 Crossref Scopus (271) PubMed Google Scholar ). The optical fiber was coupled with a diode-pumped solid-state laser with analog amplitude modulation (Laserglow Technologies). At the beginning and end of each recording session, we delivered trains of ten 473 nm light pulses, each 5 ms long, at 1, 5, 10, 20 and 50 Hz, with an intensity of 5–20 mW/mm 2 at the tip of the fiber. To be included in our dataset, neurons had to fulfill three criteria. (i) The neurons’ spike timing must be significantly modulated by light pulses. We tested this by using the stimulus associated spike latency test (SALT) ( Kvitsiani et al., 2013 37. Kvitsiani, D. ∙ Ranade, S. ∙ Hangya, B. ... Distinct behavioural and network correlates of two interneuron types in prefrontal cortex Nature. 2013; 498 :363-366 Crossref Scopus (325) PubMed Google Scholar ). We used a significance value of p < 0.05, and a time window of 10 ms after laser onset. (ii) Laser-evoked spikes must be near-identical to spontaneous spikes. This ensured that light-evoked spikes reflected actual spikes instead of photochemical artifacts. (iii) Neurons must have a short latency to spike following laser pulses, and little jitter in spike latency. Post hoc histological analysis showed that the lateral-most recordings penetrated through the SNc. We therefore excluded these recordings from the main analysis. Most of our analyses were based on all of the remaining dopamine neurons recorded in VTA (ML position < 900 μm, 102 neurons, except for Figure 5 D).
Mice were perfused with phosphate buffered saline (PBS) followed by 4% paraformaldehyde in PBS. The brains were cut in 100-μm coronal sections using a vibratome (Leica). Brain sections were loaded on glass slides and stained with 4′,6-diamidino-2-phenylindole (DAPI, Vectashield). The locations of fiber and tetrode tips were determined using the standard mouse brain atlas ( Franklin and Paxinos, 2008 22. Franklin, K.B. ∙ Paxinos, G. The mouse brain in stereotaxic coordinates Elsevier Academic Press, 2008 Google Scholar ).
In reinforcement learning theories ( Sutton, 1988 62. Sutton, R.S. Learning to predict by the methods of temporal differences Mach. Learn. 1988; 3 :9-44 Crossref Google Scholar ), the value of a given state is defined as the sum of all future rewards, where rewards are discounted by a constant rate ( 𝛾 , discounting factor, 0 < 𝛾 ≤ 1 ) per unit time: 𝑉 ⁡ ( 𝑆 𝑡 ) = 𝑟 𝑡 + 𝛾 ⁢ 𝑟 𝑡 + 1 + 𝛾 2 ⁢ 𝑟 𝑡 + 2 + 𝛾 3 ⁢ 𝑟 𝑡 + 3 + ⋯ , (1) where 𝑟 𝑡 is the reward at time 𝑡 , 𝑆 𝑡 is the state at time 𝑡 , and 𝑉 ⁡ ( 𝑆 𝑡 ) is the value of the state 𝑆 𝑡 . Under the assumption that state transitions and rewards follow a Markov process, Equation (1) can be rewritten as: 𝑉 ⁡ ( 𝑆 𝑡 ) = 𝑟 𝑡 + 𝛾 ⋅ 𝑉 ⁡ ( 𝑆 𝑡 + 1 ) , (2) which is known as the Bellman equation ( Bellman, 1954 6. Bellman, R. The theory of dynamic programming Bull. Am. Math. Soc. 1954; 60 :503-515 Crossref Scopus (667) Google Scholar ). The agent approximates the true value 𝑉 ⁡ ( 𝑆 𝑡 ) with a learned estimate ̂ 𝑉 ⁡ ( 𝑆 𝑡 ) , so that if true value is perfectly learned, i.e., ̂ 𝑉 ⁡ ( 𝑆 𝑡 ) = 𝑉 ⁡ ( 𝑆 𝑡 ) , then ̂ 𝑉 ⁡ ( 𝑆 𝑡 ) = 𝑟 𝑡 + 𝛾 ⋅ ̂ 𝑉 ⁡ ( 𝑆 𝑡 + 1 ) (3) However, before the agent has learned the true value, the left-hand and right-hand sides of Equation (3) will not be equal on average. The difference between these two terms represents the error in value prediction, and as such defines the temporal difference reward prediction error (TD RPE, or 𝛿 ): 𝛿 𝑡 = 𝑟 𝑡 + 𝛾 ⋅ ̂ 𝑉 ⁡ ( 𝑆 𝑡 + 1 ) − ̂ 𝑉 ⁡ ( 𝑆 𝑡 ) (4) According to this definition, the TD RPE contains a difference between the estimated values of states that are evaluated at consecutive time points, 𝛾 ⋅ ̂ 𝑉 ⁡ ( 𝑆 𝑡 + 1 ) − ̂ 𝑉 ⁡ ( 𝑆 𝑡 ) . When 𝛾 = 1 , this term is exactly the temporal derivative of the estimated value function. When 𝛾 is not 1 but close to it, this term is approximately the derivative of estimated value. Thus, the TD RPE is approximately the derivative of estimated value, plus rewards received ( 𝑟 𝑡 ) ( Gershman, 2014 23. Gershman, S.J. Dopamine ramps are a consequence of reward prediction errors Neural Comput. 2014; 26 :467-471 Crossref Scopus (35) PubMed Google Scholar ). As a result of this property, unexpected increases and decreases in value result in positive and negative transient (“phasic”) changes in the TD RPE, respectively.
TD RPEs, as defined by Equation (4) , account for three features of dopamine responses in simple classical conditioning paradigms ( Schultz et al., 1997 57. Schultz, W. ∙ Dayan, P. ∙ Montague, P.R. A neural substrate of prediction and reward Science. 1997; 275 :1593-1599 Crossref Scopus (6380) PubMed Google Scholar ): 1 Dopamine neurons are excited by a cue that predicts future reward. In TD models, this occurs because the reward-predicting cue indicates that value at the time of cue presentation is greater than originally expected (i.e., the animal now expects that a reward is coming). 2 When a predicted reward is omitted, dopamine neurons transiently reduce their firing below baseline. In TD models, this occurs because value at the time of omitted reward is now less than originally expected. 3 Unpredicted rewards excite dopamine neurons. However, when a cue predicts delivery of reward, dopamine neurons’ response to the predicted reward is greatly reduced. In TD models, this occurs because excitation due to received reward is canceled out by the negative response in 2.
Consider trials in which a single reward is presented at time 𝑇 . Then before reward is received ( 𝑡 < 𝑇 ) , the TD RPE is simply 𝛿 𝑡 = 𝛾 ⋅ ̂ 𝑉 ⁡ ( 𝑆 𝑡 + 1 ) − ̂ 𝑉 ⁡ ( 𝑆 𝑡 ) (5) How must value vary with time in order to produce ramping TD RPEs? We can examine this question by writing the necessary and sufficient condition for a monotonic increase in TD RPEs, i.e., 𝛿 𝑡 + 1 > 𝛿 𝑡 (6) for all 𝑡 < 𝑇 . Expanding Inequality (6), 𝛾 ⋅ ̂ 𝑉 ⁡ ( 𝑆 𝑡 + 2 ) − ̂ 𝑉 ⁡ ( 𝑆 𝑡 + 1 ) > 𝛾 ⋅ ̂ 𝑉 ⁡ ( 𝑆 𝑡 + 1 ) − ̂ 𝑉 ⁡ ( 𝑆 𝑡 ) , (7) which can be rewritten as ( 1 − 1 𝛾 ) ⁢ ( ̂ 𝑉 ⁡ ( 𝑆 𝑡 + 1 ) − ̂ 𝑉 ⁡ ( 𝑆 𝑡 ) ) + ( ̂ 𝑉 ⁡ ( 𝑆 𝑡 + 2 ) − 2 ⋅ ̂ 𝑉 ⁡ ( 𝑆 𝑡 + 1 ) + ̂ 𝑉 ⁡ ( 𝑆 𝑡 ) ) > 0 (8) The first term on the left-hand side in Inequality (8) corresponds to the temporal derivative of estimated value, scaled by a negative constant, whereas the second term corresponds to the second derivative of estimated value ( Mikhael et al., 2019 45. Mikhael, J.G. ∙ Kim, H.R. ∙ Uchida, N. ... Ramping and state uncertainty in the dopamine signal bioRxiv. 2019; Crossref Scopus (0) Google Scholar ).
Inequality (8) represents the condition for ramping TD RPEs. Note that when 𝛾 is close to one, the first term is close to zero. Hence, the condition is approximately that the second derivative must be greater than zero, a property that all convex functions satisfy. The exact condition is more restrictive, however: Because value increases with time, the first term is negative. Hence, for the condition to be satisfied, the second term must be positive enough to outweigh the negative first term. Roughly speaking, value functions must be “convex enough” to satisfy the ramping condition.
For an illustration, in Figure S1 A we show TD RPEs corresponding to a number of different value functions. It is straightforward to show that value functions in the top panel that are drawn in green satisfy the ramping condition over the evaluated domain, whereas those drawn in red do not. As shown in the bottom panel, only value functions satisfying the ramping condition (Inequality (8)) produce ramping TD RPEs.
We take states to correspond to locations, and let us assume that the value function is quadratic with states (i.e., ̂ 𝑉 ⁡ ( 𝑆 ) ∼ 𝑆 2 ). This value function obeys the ramping condition ( Figure S1 A, green curves). We show in Figure S1 B how progressing through states with variable speed results in value functions of varying convexity (and first derivative) when plotted against time. Applying Equation (4) to these value functions results in TD RPEs that ramp and whose magnitudes increase with speed.
Error bars and shadings indicate mean ± s.e.m. unless otherwise noted. A significance level of 0.05 was used to determine significant difference. Most of the statistical analyses were performed using a non-parametric test, Wilcoxon signed-rank test unless otherwise noted.
Power line noise in the raw voltage signals was removed by notch filter (MATLAB, Natick, MA). A baseline of the voltage signal was defined by the lowest 10% of signals using a 2-min window. The baseline was subtracted from the raw signal, and the results were z-scored by a session-wide mean and standard deviation ( Figures S2 A–S2C). For plotting average dopamine responses in Experiment 7 using fiber fluorometry, the fluorescent level from 1-0 s before trial onset was subtracted. Both GCaMP signals and dopamine sensor signals were processed in the same way.
Lick timing was defined as deflection points (peaks) of the output signals above a threshold. To plot the time course of licks, instantaneous lick rate was computed by a moving average using a 200-ms window.
We used the following time window to quantify the lick rate. Impulsive lick: from visual scene movement onset to 2 s before reward; anticipatory lick: [-1 s 0 s] relative to reward; post-reward lick: [0 s 2 s] relative to reward. The same temporal windows are used for quantifying speed. Net anticipatory licking and anticipatory slowdown are defined as below: N e t a n t i c i p a t o r y l i c k i n g = a n t i c i p a t o r y l i c k r a t e – i m p u l s i v e l i c k r a t e A n t i c i p a t o r y s l o w d o w n = i m p u l s i v e s p e e d – a n t i c i p a t o r y s p e e d
We used the trials in the standard condition to quantify the ramping of fluorescent signals. We computed the Pearson correlation coefficient between time points and z-scored fluorescent signals using either individual trials or averaged response. For the linear track tasks, we used the time window of [-3.5 s −1 s] relative to reward onset for fiber fluorometry data and [-5 s −1 s] for spiking data. We used a smaller window for fluorometry as the slowly delaying response to stimulus or movement onsets often biases the slope of the ramping. For the moving-bar tasks, we used the time window of [-4.5 s −1 s] relative to reward onset.
Lick, locomotion speed, and z-scored dopamine responses for individual trials were aligned by external events (e.g., trial start or teleport onset), and then smoothed using a moving average method. We used a 200 ms time window for licking and spike signals. We did not smooth locomotion speed and fluorometry signals. The results were then averaged across trials for each experimental condition to generate a session-averaged time course.
For fluorometry recording experiments, we typically ran two sessions for each experimental protocol. Since we also did not observe a significant difference in Ramping R or Test R (see below for definition) between the first and second sessions in the calcium data, we used the second session to plot population-averaged time courses and to perform statistical analyses. We computed the mean of session-averaged time courses from the second session dataset (as the average of all session averages) along with the standard error (the total number of sessions being the sample size) for each experimental condition. Population-average time courses are used to summarize behavior and dopamine responses. We used both sessions for the dopamine sensor data in plotting population PSTHs.
Responses to teleport and pause were quantified by peaks of session-averaged time courses using time windows [0.6 s – 2.1 s] and [2 s – 5 s] relative to the teleport and pause onset, respectively. Peaks in the test conditions were normalized by peaks in the standard condition using time window from trial start to reward onset ( Figures 2 D, left, and 2H, left).
In the teleport conditions, forward scene movement was maintained before and after teleports. As a result, phasic responses to teleports can be contaminated by ramping. For more accurate model comparisons, we generated model responses based on state value predictions ( Figures S4 A–S4D). For example, if dopamine signals represent RPEs, the deviation from the prediction will be systematically modulated by the conditions: a large positive deviation for long-distance teleport, a small positive deviation for short-distance teleport, and a negative deviation for pause trials. The process begins with a session-averaged time course in the standard condition. Model responses were shifted in time by the amount shortened by teleport (2.2 s for long teleport, 0.25 s for short teleport) or lengthened by pause (5 s). The results were further delayed by 0.3 s to account for neural latency in GCaMP signal. The residual responses were then defined as the subtraction of model response from empirical responses. Deviation from value model was defined as average residual response using time windows [0.6 s – 2.1 s] and [2 s – 5 s] relative to the teleport and pause onset, respectively ( Figures 2 D, right, and 2H, right). The baseline activity for each trial, defined by average response using time window [–1 s - 0 s] from trial start, was subtracted from the average residual responses.
To quantify the change of calcium responses at the time of teleport in Experiment 5c ( Figure 4 J) and Experiment 6 ( Figure 4 M), we first computed mean responses using a pre-teleport window (−0.2 s and 0 s relative to teleport) and a post-teleport window (0.6 s and 2.1 s relative to teleport) for each session. We then subtracted the responses using the first window from the responses using the second window.
For individual trials, responses to reward, teleport, pause were quantified by averaging responses using time windows [0.05 s - 0.45 s], [0.1 s - 0.5 s], [0.1 s - 0.5 s] relative to the events of interest, respectively. Baseline responses were defined by average responses using time window [–1 s - 0 s] relative to trial start. The baseline responses were subtracted from the responses of interests to obtain a net modulation by the events.
We reasoned that the key difference may lie in the different kinetics between spike and calcium signals. That is, a single spike produces a seconds-timescale increase in calcium due to the slow dynamics of calcium and the kinetics of calcium indicators (GCaMP6m). To test our hypothesis, we generated predicted calcium signals based on the spiking activity obtained in our recording experiment and an impulse response of GCaMP6m to a single spike ( Figure S5 P). We estimated GCaMP responses of a single neuron based on a relationship between a single spike and GCaMP response ( Chen et al., 2013b 12. Chen, T.-W. ∙ Wardill, T.J. ∙ Sun, Y. ... Ultrasensitive fluorescent proteins for imaging neuronal activity Nature. 2013; 499 :295-300 Crossref Scopus (4196) PubMed Google Scholar ). We convolved the spike train from the entire session with the GCaMP kernel ( Figure S5 P) to obtain estimated GCaMP signals from a single neuron activity ( Figure 5 F). GCaMP signals measured from fiber fluorometry can be approximated by calcium signals pooled across neurons. To estimate the fluorometry response of a single trial, we randomly selected single trials of convolved responses in the same experimental condition aligned by the event of interest and summed up the convolved responses across neurons. We repeated this for multiple trials (n = 100 for Figure 5 F; n = 200 for Figures 5 K and 5L) to generate predicted GCaMP responses.
The results were then transformed into z-scores. For Figure 5 F, the z-scored responses were baseline-subtracted for each subgroup of neurons. It should be noted that the transformation into z-scores effectively discards the information about baseline firing. This is a part of the reasons why ramping signals can be exaggerated relative to the baseline. We note that the quantification of fluorometry signals are often based on relative changes from baseline, with the baseline defined as the level of fluorescence in a certain time window. This method also discards the information about the level of baseline activity, and may exaggerate ramping signals such as those observed in the present study.
The systematic deviation from value model across conditions was quantified using Spearman correlation for each session. For Experiment 1 (teleport and pause), numbers were assigned to each condition to quantify the trial-by-trial correlation between test conditions and residual responses based on the value model (long teleport = 1; short teleport = 2; pause = 3). Significant negative correlations indicate that residual responses are big in the long teleport, medium in the short teleport, and the smallest in the pause condition. Alpha = 0.05 was used to determine significanace in Test Rs. For Experiment 2 (three teleports), we computed Spearman correlations between position and the residual responses. Positive correlations indicate that responses to teleports increase with proximity to reward location. For Experiment 3, we computed Spearman correlation between speed condition and baseline-corrected (using time window [–1 s – 0 s] from trial start) average response from trial start to reward onset. Numbers were assigned such that positive correlations indicate that responses increase with scene speed (slow speed = 1; standard speed = 2; fast speed = 3). In addition to testing the significance of trial-by-trial correlation in an individual session, we further tested whether the median of Test R s across animals is significantly different from zero using Wilcoxon signed-rank test.
We performed statistical analyses at both single-session and population levels. For individual-session analysis, average responses from individual trials were quantified using a temporal window locked to an external event (e.g., reward onset). Non-parametric tests (e.g., Wilcoxon signed-rank test) were used to test whether responses are significantly greater or smaller than reference (e.g., zero). A dataset with a significant difference was marked by a filled circle. For population-level analysis, the mean responses of individual sessions were used for comparisons between conditions or comparisons against a reference value (e.g., zero or one) using Wilcoxon signed-rank test. A significant difference between conditions was marked by a filled circle on the horizontal lines that connect the two conditions. A significant difference from baseline was marked using a p value or a star mark on top of each condition. We used two-tailed tests for all statistical tests.
We examined whether and how much task-related behaviors can account for the variability in Ramping R across sessions. For each session, we quantified average Ramping R , net anticipatory lick rate, and running speed. We examined whether lick rate or running speed can account for the variability in Ramping R using analysis of covariance (ANCOVA). In the analysis, Ramping R was dependent variable, either lick rate or running speed was covariates, and animal identity was categorical independent variable.
We examined how trial-to-trial variability in the mean dopamine responses during approach can be accounted for by visual scene speed, locomotion speed, and a global trend by multiple linear regression ( Figure 2 L, right). 𝑅 ⁢ 𝑒 ⁢ 𝑠 ⁢ 𝑝 ⁢ 𝑜 ⁢ 𝑛 ⁢ 𝑠 ⁢ 𝑒 = 𝛽 0 + 𝛽 𝑣 ⁢ 𝑖 ⁢ 𝑠 ⁢ 𝑉 𝑣 ⁢ 𝑖 ⁢ 𝑠 + 𝛽 𝑙 ⁢ 𝑜 ⁢ 𝑐 ⁢ 𝑉 𝑙 ⁢ 𝑜 ⁢ 𝑐 + 𝛽 𝑡 ⁢ 𝑟 ⁢ 𝑖 ⁢ 𝑎 ⁢ 𝑙 ⁢ 𝑇 ⁢ 𝑟 ⁢ 𝑖 ⁢ 𝑎 ⁢ 𝑙 𝑛 ⁢ 𝑢 ⁢ 𝑚 ⁢ 𝑏 ⁢ 𝑒 ⁢ 𝑟 + 𝜀
For fluorometry data, z-scored dopamine signals and other behavior signals (stored at 1kHz) were downsampled to 100Hz and then averaged for each condition aligned by trial start. We first fitted individual sessions independently ( Figure 3 C). For combined dataset ( Figure 3 D, ‘all conditions’; Figures 3 E–3H), we concatenated data from different experiments. This allowed us to fit the data from the same animal using a single set of parameters. Data from Experiment 4 were not combined as the data were collected using different animals ( Figure S4 H). Since the number of animals is not large, data were included in the combined dataset (Experiments 1-3) as long as the animal has at least one manipulated experiment. We obtained the kernel for GCaMP ( F ) by averaging GCaMP responses to a delivery of unexpected reward during the last day of training ( Figure S5 P). The results were similar when we used a single-spike response filter ( Chen et al., 2013b 12. Chen, T.-W. ∙ Wardill, T.J. ∙ Sun, Y. ... Ultrasensitive fluorescent proteins for imaging neuronal activity Nature. 2013; 499 :295-300 Crossref Scopus (4196) PubMed Google Scholar ) that we used for predicted calcium response ( Figure 5 E).
For spiking data, responses were fitted for each neuron. We used neurons that have both Experiment 1 and Experiment 3 (n = 78 neurons). Due to the low firing rates of dopamine neurons (∼5 spikes/s), time courses of firing rate using a 100ms window were often noisy and caused low R 2 . We further smoothed it using a 250 ms window. The results were concatenated across experiments, and then z-scored. Z-scoring enabled us to use the same boundary condition for almost all models parameters as what we used for fitting fluorometry data. For the kernel filter ( F ), we used average response to unexpected reward ( Figure S5 P).
For quantitative comparisons between the state value and RPE models ( Figure 3 ), we examined which model provides a better fit to the mean calcium signals from each animal. For this analysis, we focused on the pre-reward period where ramping dopamine signals were observed. We first defined the shape of the value function across space. We then predicted the time course of value or TD RPE signal in each experimental condition. We then converted the predicted value or TD RPE into either calcium signals or firing rates, and these predictions were compared with the mean responses in the data.
The TD RPE at time 𝑡 ( 𝛿 𝑡 ) is defined by: 𝛿 𝑡 = 𝛾 ⋅ ̂ 𝑉 ⁡ ( 𝑆 𝑡 + 1 ) − ̂ 𝑉 ⁡ ( 𝑆 𝑡 ) where 𝑆 𝑡 is the state at time 𝑡 , ̂ 𝑉 ⁡ ( 𝑆 𝑡 ) is the estimated value of the state 𝑆 𝑡 , and 𝛾 is the discounting factor ( 0 < 𝛾 ≤ 1 ) . Note that this formulation excludes reward delivery times. To fit responses in the linear track tasks, we used the position along the linear track as 𝑆 𝑡 ; that is, the state value is defined as the value of the position. To fit responses in the moving-bar tasks, we used the vertical position of the bar as 𝑆 𝑡 .
The state value is expected to increase as the animal gets closer to the goal location. For the TD signal to be positive and ramp up, the value function must take a convex shape along the relevant dimension along which the animal traverses (See STAR Methods , Theoretical backgrounds ). Because the exact shape of the state value is unknown, we examined several shapes of value functions. Our first model defines the shape of the value function as an exponentially decaying function across space with the discounting factor 𝜏 . ̂ 𝑉 ⁡ ( 𝑆 𝑡 ) = 𝛽 1 ⋅ 𝜏 ( 𝑆 𝑇 − 𝑆 𝑡 ) where 𝛽 1 is a coefficient representing the value at the goal location while 𝑆 𝑇 is the position of the goal (target), and therefore, 𝑆 𝑇 − 𝑆 𝑡 corresponds to the distance from the current position to the goal. Note that the discounting factor 𝜏 need not be the same as the discounting factor 𝛾 for the definition of TD errors.
We also fitted the measured data using a time-to-reward model (Δt-to-reward). In this model, the value function is computed based on the estimated time to obtain the reward. The estimation is done by dividing the distance to reward by the instantaneous speed (smoothed by a 100 ms window). ̂ 𝑉 ⁡ ( 𝑆 𝑡 ) = 𝛽 1 ⋅ 𝛾 ( Δ ⁢ 𝑡 ) where Δ t = ( 𝑆 𝑇 − 𝑆 𝑡 ) / 𝑣 𝑡 . Note that this model produces some features that other value models do not. For example, when the animal is paused in Experiment 1, Δt becomes infinite and the value at the moment becomes zero. When the animal is teleported to the closer position, the instantaneous speed suddenly increases, which results in a transient increase of value. Although the model predictions in Experiment 1 somehow mimic those in the TD models, the predicted response in Experiment 3 does not increase with speed, resembling other value models.
Latent varables (value and TD RPE) in our models are computed based on the instantaneous position sampled at 100 Hz. Due to the perceptual delay as well as the intrinsic biological mechanisms underlying the signals (e.g., kinetics of action potential or intracellular calcium), The dynamics of measured neural signals are slower than the dynamics of latent variables in our models. To account for the difference in the temporal dynamics, the predicted value or TD RPE was convolved with a kernel filter ( F ) to reflect the kinetics of measured signals. The filter was estimated from the empirical impulse function in response to uncued reward as described above. For the TD RPE model, the calcium signals 𝑦 𝑡 were predicted by convolving 𝛿 𝑡 with the kernel filter and an offset term. 𝑦 𝑡 = ( 𝛽 0 + 𝛿 𝑡 ) ∗ 𝐹 + 𝜖 𝑡 where 𝜀 𝑡 denotes Gaussian-distributed random error. For the value model, calcium signals were predicted by convolving ̂ 𝑉 ⁡ ( 𝑆 𝑡 ) with the kernel filter. 𝑦 𝑡 = ( 𝛽 0 + ̂ 𝑉 ⁡ ( 𝑆 𝑡 ) ) ∗ 𝐹 + 𝜖 𝑡 We also fitted the measured data using a RPE-value mixture model. This model is a weighted linear sum of the RPE and value terms. The coefficient for the RPE model reflects the relative contribution of RPE when both models were used to explain the data. 𝑦 𝑡 = ( 𝛽 𝑜 + 𝛼 ⁢ 𝑍 ⁡ ( 𝛿 𝑡 ) + ( 1 − 𝛼 ) ⁢ 𝑍 ⁡ ( ̂ 𝑉 ⁡ ( 𝑆 𝑡 ) ) ) ∗ 𝐹 + 𝜖 𝑡 where Z(x) denotes z-scoring. We noticed that occasionally the best fit results consist of 𝛿 𝑡 and ̂ 𝑉 ⁡ ( 𝑆 𝑡 ) that were not interpretable (e.g., positive ̂ 𝑉 ⁡ ( 𝑆 𝑡 ) and negative 𝛿 𝑡 whose mangitudes were much larger than the measured signals). To avoid this, we applied a magnitude constraint on ̂ 𝑉 ⁡ ( 𝑆 𝑡 ) by adjusting the cost function. If the range of convolved ̂ 𝑉 ⁡ ( 𝑆 𝑡 ) in the standard condition ( 𝐿 ̂ 𝑉 ) was larger than twice of the range in the measured signal ( 𝐿 ) , the sum of squared residuals (SSR) was increased by a multiplier as shown below. This constraint made each component reasonable without a noticeable effect on the goodness-of-fits (r square decreased on average by 0.06% for fluorometry data, 0.03% for spike data). A d j u s t e d S S R = S S R ∗ 𝐿 ̂ 𝑉 𝐿 ∗ 1 0 0 , i f 𝐿 ̂ 𝑉 > 𝐿 Finally, we fitted the measured data using a model in which the derivative nature of the model itself can vary from being a zeroth order derivative (equivalent to the value model) to a second order derivative (a model with a first order derivative is approximately the RPE model) in a continuous manner. Fractional derivatives can be defined to extend differential calculus with integer numbers to non-integer numbers. We used the MATLAB function fgl_deriv that computes the fractional derivatives using Grünwald–Letnikov formulation ( Podlubny, 1998 51. Podlubny, I. Fractional differential equations: an introduction to fractional derivatives, fractional differential equations, to methods of their solution and some of their applications Academic Press, 1998 Google Scholar ). 𝑦 𝑡 = ( 𝛽 𝑜 + 𝑓 ⁢ 𝑔 ⁢ 𝑙 _ 𝑑 ⁢ 𝑒 ⁢ 𝑟 ⁢ 𝑖 ⁢ 𝑣 ( ̂ 𝑉 ⁡ ( 𝑆 𝑡 ) , 𝛼 ) ∗ 𝐹 + 𝜀 𝑡 A model fit was performed by minimizing the sum of squared residuals (SSR) in the time window from the scene movement onset to 0.5 s before reward delivery. To find parameters that minimize SSR numerically, we used a non-linear function solver with constraints (fmincon, MATLAB). Sets of the example starting point (p0), lower bound (LB) and upper bound (UB) are as follows: • TD model, exponential ( 𝛾 , 𝜏 , 𝛽 1 , 𝛽 0 ) : ̂ 𝑉 ⁡ ( 𝑆 𝑡 ) = 𝛽 1 ⋅ 𝜏 ( 𝑆 𝑇 − 𝑆 𝑡 ) , 𝛿 𝑡 = 𝛾 ⋅ ̂ 𝑉 ⁡ ( 𝑆 𝑡 + 1 ) − ̂ 𝑉 ⁡ ( 𝑆 𝑡 )
p0 = [0.96 0.96 25 0]; LB = [0.8 0.8 1 –2]; UB = [1 1 150 2]; • Value model, exponential ( 𝜏 , 𝛽 1 , 𝛽 0 ) : ̂ 𝑉 ⁡ ( 𝑆 𝑡 ) = 𝛽 1 ⋅ 𝜏 ( 𝑆 𝑇 − 𝑆 𝑡 )
p0 = [0.96 0.6 0]; LB = [0.8 0 –2]; UB = [1 10 2]; • Value model, time-to-reward ( 𝜏 , 𝛽 1 , 𝛽 0 )
p0 = [0.5 0.6 0]; LB = [0.1 0 –2]; UB = [1 10 2]; • TD-value mixture model, exponential ( 𝛾 , 𝜏 , 𝛽 1 , 𝛽 0 , 𝛼 ) : ̂ 𝑉 ⁡ ( 𝑆 𝑡 ) = 𝛽 1 ⋅ 𝜏 ( 𝑆 𝑇 − 𝑆 𝑡 )
p0 = [0.96 0.96 25 0 0.5]; LB = [0.8 0.8 0.005 –2 0]; UB = [1 1 500 2 1]; • fractional derivative model, exponential ( 𝜏 , 𝛽 1 , 𝛽 0 , 𝛼 )
p0 = [0.95 0.6 0 0.5]; LB = [0.8 0 –2 0]; UB = [1 200 2 2];
Starting points of parameter search were either the example starting point (p0) or randomly drawn from a uniform distribution ranging between the lower and upper bounds. The solver was repeated 250 times (50 times for the fractional derivative), and the parameters with the minimum SSR were chosen.
Empirical value functions may deviate from a simple mathematical form (e.g., exponential). To model more general shapes of the value function, we also used a fifth order polynomial regression. ̂ 𝑉 ⁡ ( 𝑆 𝑡 ) = ∑ 5 𝑘 = 0 𝛽 𝑘 ⁢ 𝑆 𝑘 𝑡 𝛿 𝑡 = 𝛾 ⋅ ̂ 𝑉 ⁡ ( 𝑆 𝑡 + 1 ) − ̂ 𝑉 ⁡ ( 𝑆 𝑡 ) = ∑ 5 𝑘 = 0 𝛽 𝑘 ⁢ ( 𝛾 ⁢ 𝑆 𝑘 𝑡 + 1 − 𝑆 𝑘 𝑡 ) 𝑦 𝑡 = ̂ 𝑉 ⁡ ( 𝑆 𝑡 ) ∗ 𝐹 + 𝜖 = ∑ 5 𝑘 = 0 𝛽 𝑘 ⁢ ( 𝑆 𝑘 𝑡 ∗ 𝐹 ) + 𝜖 𝑦 𝑡 = 𝛿 𝑡 ∗ 𝐹 + 𝜖 = ∑ 5 𝑘 = 0 𝛽 𝑘 ⁢ ( ( 𝛾 ⁢ 𝑆 𝑘 𝑡 + 1 − 𝑆 𝑘 𝑡 ) ∗ 𝐹 ) + 𝜖 The coefficients of the value model can be found deterministically. For the TD model, we performed regression using a range of 𝛾 values from 0.97 to 1 in steps of 0.0005 and used the 𝛾 value with the maximum R 2 .
Since polynomial regression allows the value function to decrease as animals approach, we further used a constrained linear least square method (‘lsqlin’ function in MATLAB) to make the value function monotonically increasing. V(s + 1) – V(s) > 0, s = 0, 2, 3, … 94. For the TD model, SSR were computed over a set of 𝛾 values, and the best parameters were chosen as we did for the regression model.
To compare goodness-of-fits across models, Akaike information criterion (AIC) ( Akaike, 1973 1. Akaike, H. Information Theory as an Extension of the Maximum Likelihood Principle Petrov, B.N. ∙ Csaki, F. (Editors) Second International Symposium on Information Theory Akadémiai Kiadó, 1973; 267-281 Google Scholar ) was used. 𝐴 ⁢ 𝐼 ⁢ 𝐶 = 𝑁 × l n ⁡ ( 𝑆 ⁢ 𝑆 ⁢ 𝑅 𝑁 ) + 2 ⁢ 𝐾 where N is the number of data points, SSR is the squared sum of residuals, K is the number of free parameters. AIC was computed using the time window from the scene movement onset to 0.5 s before reward delivery. When computing AIC for polynomial fits, the number of parameters ( K ) was increased by one to compensate for the exhaustive search for 𝛾 . For comparisons, we computed differential AIC between a target model and a reference model ( 𝛥 ⁢ 𝐴 ⁢ 𝐼 ⁢ 𝐶 = 𝐴 ⁢ 𝐼 ⁢ 𝐶 𝑡 ⁢ 𝑎 ⁢ 𝑟 ⁢ 𝑔 ⁢ 𝑒 ⁢ 𝑡 − 𝐴 ⁢ 𝐼 ⁢ 𝐶 𝑟 ⁢ 𝑒 ⁢ 𝑓 ) . Positive value indicates that the reference model explains the data better than the target model considering the number of parameters.
Permutation tests were used to test significance of R square and AIC difference. The data were randomly shuffled using 1 s bins and the same fitting procedures were performed to find the best fit. We repeated it 1000 times to obtain a distribution of goodness-of-fits. To test significance of R square, P value was defined as the faction of R squares from shuffling that is greater than the R square from actual (unshuffled) data. To test significance of AIC difference, a distribution of shuffled AIC difference was obtained by subtracting the AICs of the exponential TD model from the AICs of the model of interest. P value was defined as the fraction of shuffled AIC difference whose values are more extreme than the empirical AIC difference. Alpha = 0.05 was used to determine significance. Fractional derivative model was omitted for significant test as the fractional derivatives computation took orders of magnitude longer than other fittings thus it was not feasible to perform a permutation test.
We reconstructed the shape of value function based on the the optimal fit parameters in the fit using polynomial basis function with monotonically increasing constraint ( Figures 3 F and 5 F). We first generated the time course of position in the standard condition, and the value function was computed based on the position at each time point. The results was normalized by the peak for each animal (flurometry) or neuron (spike). RPE signals were computed based on the reconstructed value function and the optimal gamma. The results were averaged across animals ( Figure 3 F, right, dark green) or neurons ( Figure 5 R, right, dark green). GCaMP filter ( Figure S5 P, green) was convolved with the RPE signals and the results were averaged across animals ( Figure 3 F, green) or neurons ( Figure 5 F, green). For smooth visualization of the predicted signals, the long-tail part of the GCaMP filter ( Figure S5 P, green; 4 s to 5 s) was multiplied by a linear function, y = (5 – x).
First, the RPE model contained the initial transient response that corresponds to a stepwise increase of value at the trial start ( Figure 3 F, right). These responses resemble dopamine neuron responses to cues that predict reward or a trial start signal ( Bromberg-Martin et al., 2010 8. Bromberg-Martin, E.S. ∙ Matsumoto, M. ∙ Hikosaka, O. Distinct tonic and phasic anticipatory activity in lateral habenula and dopamine neurons Neuron. 2010; 67 :144-155 Full Text Full Text (PDF) Scopus (109) PubMed Google Scholar ; Schultz et al., 1997 57. Schultz, W. ∙ Dayan, P. ∙ Montague, P.R. A neural substrate of prediction and reward Science. 1997; 275 :1593-1599 Crossref Scopus (6380) PubMed Google Scholar ). Second, the obtained value function showed that the convexity of the value function decreases closer to the goal ( Figure 3 F, left), which results in a decrease in TD errors (though, it is still positive) and, the corresponding calcium signals immediately before reward delivery ( Figure 3 F, right). A similar change in value function as well as a slight decrease in dopamine signals before reward was observed in previous studies, which suggested the importance of state uncertainty in generating these changes ( Cohen et al., 2012 14. Cohen, J.Y. ∙ Haesler, S. ∙ Vong, L. ... Neuron-type-specific signals for reward and punishment in the ventral tegmental area Nature. 2012; 482 :85-88 Crossref Scopus (899) PubMed Google Scholar ; Starkweather et al., 2017 59. Starkweather, C.K. ∙ Babayan, B.M. ∙ Uchida, N. ... Dopamine reward prediction errors reflect hidden-state inference across time Nat. Neurosci. 2017; 20 :581-589 Crossref Scopus (106) PubMed Google Scholar ).

Section: Acknowledgments

We thank C. Harvey and D. Aronov for the virtual reality system. We thank B. Babayan, W. Menegas, and E. Soucy for fiber fluorometry setups. We thank A. Shakeel for histology. We thank J. Assad and K. Svoboda for comments. We also thank the members of the Uchida lab for discussions and critical reading of the manuscript. Some analyses were run on the FASRC Cannon cluster, supported by the FAS Division of Science Research Computing Group at Harvard University. This work was supported by NIH grants U19 NS113201 (to N.U. and S.J.G.), R01MH095953 (to N.U.), R01MH101207 (to N.U.), NS108740 (to N.U.), T32GM007753 (to J.G.M.), T32MH020017 (to J.G.M.), and U01NS103558 (to Y.L.); the Simons Collaboration on Global Brain (to N.U.); a Harvard Mind Brain and Behavior faculty grant (to S.J.G. and N.U.), a research fellowship from the Alfred P. Sloan Foundation (to S.J.G.); and the Junior Thousand Talents Program of China (to Y.L.).
H.R.K. and N.U. conceived and supervised the entire project. H.R.K. conducted fiber fluorometry experiments and was involved in all other experiments. A.N.M. conducted electrophysiology and rabies fiber fluorometry. The electrophysiology experiment was designed by H.R.K., A.N.M., Paul Masset, and N.U. The electrophysiology data were analyzed by H.R.K. following data preparation and initial analysis by A.N.M. P.B. conducted some fiber fluorometry experiments. The dopamine sensor was developed by F.S., Y.Z., and Y.L. and tested by I.T.-K. and M.W.-U. J.G.M. and S.J.G. provided theoretical analysis and advised data analysis. H.R.K. analyzed the data and wrote the first draft. All the other authors discussed the results and commented on the manuscript.
The authors declare no competing interests.
